# S3 Upload Utility - AI Integration Guide

This guide enables AI agents (Claude Code, Cursor, GitHub Copilot, etc.) to autonomously integrate this S3 upload utility into other projects.

## Quick Start

### 1. Installation

```bash
# Via GitHub URL (recommended - no PAT required for public repos)
npm install github:EarthLinkNetwork/lime

# Or add to package.json
{
  "dependencies": {
    "@earthlinknetwork/lime": "github:EarthLinkNetwork/lime"
  }
}

# SSH alternative
npm install git+ssh://git@github.com:EarthLinkNetwork/lime.git

# Specific version/branch
npm install github:EarthLinkNetwork/lime#v1.0.0
npm install github:EarthLinkNetwork/lime#main
```

> **Note**: The `prepare` script runs automatically on install, building all packages.

### 2. Backend Deployment (AWS CDK)

```bash
cd node_modules/@earthlinknetwork/lime/packages/backend

# Set AWS profile
export AWS_PROFILE=your-profile

# Generate a secure API key (recommended)
export VALID_API_KEYS=$(openssl rand -hex 32)
echo "Your API Key: $VALID_API_KEYS"

# Deploy with API key
npm run deploy
```

**Outputs:**
- `ApiEndpoint`: e.g., `https://xxx.execute-api.region.amazonaws.com`
- `DistributionDomain`: e.g., `d1xxx.cloudfront.net`
- `BucketName`: S3 bucket name

> **Important**: Save your API key securely. You'll need it for frontend configuration.

---

## API Key Configuration

### Option 1: Set during deployment (Recommended)

```bash
# Generate and set API key before deploy
export VALID_API_KEYS="your-secure-api-key-here"
npm run deploy
```

### Option 2: Multiple API keys

```bash
# Comma-separated for multiple keys
export VALID_API_KEYS="key1,key2,key3"
npm run deploy
```

### Option 3: Update after deployment (AWS Console)

1. Open AWS Lambda Console
2. Find the `S3UploadStack-PresignedUrlLambda-xxx` function
3. Go to **Configuration** â†’ **Environment variables**
4. Edit `VALID_API_KEYS` value
5. Save

### Option 4: Update via AWS CLI

```bash
aws lambda update-function-configuration \
  --function-name S3UploadStack-PresignedUrlLambda-xxx \
  --environment "Variables={BUCKET_NAME=your-bucket,VALID_API_KEYS=new-api-key}" \
  --profile your-profile
```

### Development Mode (Not recommended for production)

If `VALID_API_KEYS` is empty, **any non-empty API key is accepted**:

```bash
# Development only - accepts any key
export VALID_API_KEYS=""
npm run deploy
```

### Generate Secure API Key

```bash
# Using OpenSSL (recommended)
openssl rand -hex 32

# Using Node.js
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"

# Using uuidgen
uuidgen | tr -d '-'
```

### 3. Frontend Integration

```tsx
// Import from the installed package
import { S3Uploader, ImageCropper, compressImage } from '@earthlinknetwork/lime/packages/frontend/dist';
import type { S3UploaderProps, CompressionOptions } from '@earthlinknetwork/lime/packages/frontend/dist';
```

---

## Component Reference

### S3Uploader

Main upload component with built-in compression and cropping.

```tsx
<S3Uploader
  // Required props
  apiEndpoint="https://xxx.execute-api.region.amazonaws.com"
  apiKey="your-api-key"

  // CloudFront domain (recommended - returns CloudFront URL instead of S3 URL)
  cloudfrontDomain="d1xxx.cloudfront.net"

  // Optional callbacks
  onUploadComplete={(url) => console.log('Uploaded:', url)}
  onUploadError={(error) => console.error('Failed:', error)}
  onProgress={(percent) => console.log(`${percent}%`)}

  // Optional settings
  enableCompression={true}           // Default: true
  enableCrop={false}                 // Default: false
  maxFileSizeMB={10}                 // Default: 10
  allowedFileTypes={['image/jpeg', 'image/png', 'image/webp']}
  compressionOptions={{
    maxSizeMB: 2,
    maxWidthOrHeight: 1920,
    useWebWorker: true,
  }}
/>
```

### ImageCropper

Standalone image cropping component.

```tsx
<ImageCropper
  src={imageUrl}
  aspectRatio={16 / 9}              // Optional: lock aspect ratio
  onCropComplete={(blob) => {}}     // Required: receives cropped Blob
  onCancel={() => {}}               // Required: handle cancel
/>
```

### compressImage

Utility function for image compression.

```ts
import { compressImage } from '@earthlinknetwork/lime/packages/frontend/dist';

const compressedFile = await compressImage(file, {
  maxSizeMB: 1,
  maxWidthOrHeight: 1280,
  useWebWorker: true,
});
```

---

## TypeScript Types

```ts
interface S3UploaderProps {
  apiEndpoint: string;
  apiKey: string;
  /** CloudFront domain for image delivery. If provided, onUploadComplete returns CloudFront URL instead of S3 URL. */
  cloudfrontDomain?: string;
  onUploadComplete?: (url: string) => void;
  onUploadError?: (error: Error) => void;
  onProgress?: (progress: number) => void;
  maxFileSizeMB?: number;
  allowedFileTypes?: string[];
  enableCrop?: boolean;
  enableCompression?: boolean;
  compressionOptions?: CompressionOptions;
}

interface ImageCropperProps {
  src: string;
  onCropComplete: (croppedImageBlob: Blob) => void;
  onCancel: () => void;
  aspectRatio?: number;
}

interface CompressionOptions {
  maxSizeMB?: number;
  maxWidthOrHeight?: number;
  useWebWorker?: boolean;
}

interface PresignedUrlResponse {
  uploadUrl: string;
  fileUrl: string;
  key: string;
}
```

---

## CloudFront Dynamic Image Processing

Images served via CloudFront support dynamic transformations.

### URL Pattern

```
https://{cloudfront-domain}/{image-key}?{params}
```

### Supported Parameters

| Param | Description | Example |
|-------|-------------|---------|
| `w`   | Width (px)  | `?w=200` |
| `h`   | Height (px) | `?h=150` |
| `q`   | Quality (1-100) | `?q=80` |
| `r`   | Border radius (px) | `?r=20` |
| `f`   | Format (webp/png/jpeg) | `?f=webp` |

### Examples

```
# Resize to 200px width
https://d1xxx.cloudfront.net/uploads/image.jpg?w=200

# Resize with quality
https://d1xxx.cloudfront.net/uploads/image.jpg?w=300&q=85

# Rounded corners (auto PNG for transparency)
https://d1xxx.cloudfront.net/uploads/image.jpg?w=150&r=20

# Convert to WebP
https://d1xxx.cloudfront.net/uploads/image.jpg?w=400&f=webp

# Combined
https://d1xxx.cloudfront.net/uploads/image.jpg?w=180&h=180&r=10&q=90&f=png
```

---

## API Reference

### POST /presigned-url

Request a presigned URL for file upload.

**Request:**
```json
{
  "fileName": "photo.jpg",
  "contentType": "image/jpeg",
  "folder": "uploads"          // Optional, default: "uploads"
}
```

**Headers:**
```
Content-Type: application/json
X-Api-Key: your-api-key
```

**Response (200):**
```json
{
  "uploadUrl": "https://bucket.s3.amazonaws.com/...",
  "key": "uploads/uuid.jpg",
  "fileUrl": "https://bucket.s3.amazonaws.com/uploads/uuid.jpg"
}
```

**Errors:**
- `403`: Missing or invalid API key
- `400`: Missing fileName or contentType

---

## Environment Variables

### Backend (Lambda)

| Variable | Description |
|----------|-------------|
| `BUCKET_NAME` | S3 bucket name (auto-set by CDK) |
| `VALID_API_KEYS` | Comma-separated valid keys (empty = accept any) |

### CI/CD Configuration

Create `.npmrc` from `.npmrc.example`:

```bash
# For CI/CD with GitHub Actions
//npm.pkg.github.com/:_authToken=${GITHUB_TOKEN}
```

---

## AI Integration Checklist

When integrating this package:

1. [ ] Install: `npm install github:EarthLinkNetwork/lime`
2. [ ] Deploy backend: `cd packages/backend && npm run deploy`
3. [ ] Note outputs: `ApiEndpoint`, `DistributionDomain`
4. [ ] Import components in React app
5. [ ] Configure `apiEndpoint` and `apiKey` props
6. [ ] (Optional) Set `VALID_API_KEYS` in Lambda
7. [ ] Test upload functionality
8. [ ] Test CloudFront image resizing: `?w=100`

---

## Troubleshooting

### Installation fails

```bash
# Ensure Node.js >= 18
node --version

# Clean install
rm -rf node_modules package-lock.json
npm install
```

### CORS errors

1. Verify `apiEndpoint` is correct
2. Check Lambda is deployed
3. Verify S3 bucket CORS configuration

### API returns 403

1. Check `X-Api-Key` header is set
2. If `VALID_API_KEYS` is set, ensure key is in list

### Images not resizing

1. Verify image exists in S3
2. Check CloudFront distribution status
3. Ensure image-resize Lambda deployed

---

## Version Compatibility

- Node.js: >= 18.0.0
- React: >= 18.0.0
- AWS CDK: 2.x
- TypeScript: >= 5.0
