"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_s3_1 = require("@aws-sdk/client-s3");
const sharp_1 = __importDefault(require("sharp"));
const s3Client = new client_s3_1.S3Client({});
function parseQueryParams(queryParams) {
    const format = queryParams.f?.toLowerCase();
    return {
        width: queryParams.w ? parseInt(queryParams.w, 10) : undefined,
        height: queryParams.h ? parseInt(queryParams.h, 10) : undefined,
        radius: queryParams.r ? parseInt(queryParams.r, 10) : undefined,
        quality: queryParams.q ? parseInt(queryParams.q, 10) : 80,
        format: (format === 'webp' || format === 'png' || format === 'jpeg') ? format : 'auto',
    };
}
const handler = async (event) => {
    try {
        const bucketName = process.env.BUCKET_NAME;
        const key = event.pathParameters?.proxy || event.rawPath.replace(/^\//, '');
        if (!bucketName || !key) {
            return {
                statusCode: 400,
                body: JSON.stringify({ error: 'Missing bucket or key' }),
            };
        }
        const params = parseQueryParams(event.queryStringParameters || {});
        // If no resize parameters, return original
        if (!params.width && !params.height && !params.radius) {
            return {
                statusCode: 302,
                headers: {
                    Location: `https://${bucketName}.s3.amazonaws.com/${key}`,
                },
                body: '',
            };
        }
        // Get original image from S3
        const getCommand = new client_s3_1.GetObjectCommand({
            Bucket: bucketName,
            Key: key,
        });
        const response = await s3Client.send(getCommand);
        const imageBuffer = await streamToBuffer(response.Body);
        // Process image with sharp
        let sharpInstance = (0, sharp_1.default)(imageBuffer);
        // Resize
        if (params.width || params.height) {
            sharpInstance = sharpInstance.resize(params.width, params.height, {
                fit: 'inside',
                withoutEnlargement: true,
            });
        }
        // Apply rounded corners
        if (params.radius && params.radius > 0) {
            const metadata = await (0, sharp_1.default)(imageBuffer).metadata();
            const width = params.width || metadata.width || 100;
            const height = params.height || metadata.height || 100;
            const roundedCorners = Buffer.from(`<svg><rect x="0" y="0" width="${width}" height="${height}" rx="${params.radius}" ry="${params.radius}"/></svg>`);
            sharpInstance = sharpInstance.composite([
                {
                    input: roundedCorners,
                    blend: 'dest-in',
                },
            ]);
        }
        // Determine output format
        // If radius is applied, use PNG (supports transparency) unless explicitly specified
        let outputFormat = params.format || 'auto';
        if (outputFormat === 'auto') {
            outputFormat = params.radius && params.radius > 0 ? 'png' : 'webp';
        }
        // Convert to specified format
        let outputBuffer;
        let contentType;
        switch (outputFormat) {
            case 'png':
                outputBuffer = await sharpInstance.png({ quality: params.quality }).toBuffer();
                contentType = 'image/png';
                break;
            case 'jpeg':
                outputBuffer = await sharpInstance.jpeg({ quality: params.quality }).toBuffer();
                contentType = 'image/jpeg';
                break;
            case 'webp':
            default:
                outputBuffer = await sharpInstance.webp({ quality: params.quality }).toBuffer();
                contentType = 'image/webp';
                break;
        }
        return {
            statusCode: 200,
            headers: {
                'Content-Type': contentType,
                'Cache-Control': 'public, max-age=31536000',
            },
            body: outputBuffer.toString('base64'),
            isBase64Encoded: true,
        };
    }
    catch (error) {
        console.error('Error processing image:', error);
        return {
            statusCode: 500,
            body: JSON.stringify({ error: 'Image processing failed' }),
        };
    }
};
exports.handler = handler;
async function streamToBuffer(stream) {
    const chunks = [];
    for await (const chunk of stream) {
        chunks.push(Buffer.from(chunk));
    }
    return Buffer.concat(chunks);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9sYW1iZGEvaW1hZ2UtcmVzaXplL2luZGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBLGtEQUFnRTtBQUVoRSxrREFBMEI7QUFFMUIsTUFBTSxRQUFRLEdBQUcsSUFBSSxvQkFBUSxDQUFDLEVBQUUsQ0FBQyxDQUFDO0FBWWxDLFNBQVMsZ0JBQWdCLENBQUMsV0FBK0M7SUFDdkUsTUFBTSxNQUFNLEdBQUcsV0FBVyxDQUFDLENBQUMsRUFBRSxXQUFXLEVBQUUsQ0FBQztJQUM1QyxPQUFPO1FBQ0wsS0FBSyxFQUFFLFdBQVcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxXQUFXLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxTQUFTO1FBQzlELE1BQU0sRUFBRSxXQUFXLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsV0FBVyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsU0FBUztRQUMvRCxNQUFNLEVBQUUsV0FBVyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLFdBQVcsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLFNBQVM7UUFDL0QsT0FBTyxFQUFFLFdBQVcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxXQUFXLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFO1FBQ3pELE1BQU0sRUFBRSxDQUFDLE1BQU0sS0FBSyxNQUFNLElBQUksTUFBTSxLQUFLLEtBQUssSUFBSSxNQUFNLEtBQUssTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsTUFBTTtLQUN2RixDQUFDO0FBQ0osQ0FBQztBQUVNLE1BQU0sT0FBTyxHQUFHLEtBQUssRUFDMUIsS0FB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QUFDO1FBQ2YsT0FBTyxDQUFDLEtBQUssQ0FBQyx5QkFBeUIsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUNoRCxPQUFPO1lBQ0wsVUFBVSxFQUFFLEdBQUc7WUFDZixJQUFJLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxFQUFFLEtBQUssRUFBRSx5QkFBeUIsRUFBRSxDQUFDO1NBQzNELENBQUM7SUFDSixDQUFDO0FBQ0gsQ0FBQyxDQUFDO0FBNUdXLFFBQUEsT0FBTyxXQTRHbEI7QUFFRixLQUFLLFVBQVUsY0FBYyxDQUFDLE1BQTZCO0lBQ3pELE1BQU0sTUFBTSxHQUFhLEVBQUUsQ0FBQztJQUM1QixJQUFJLEtBQUssRUFBRSxNQUFNLEtBQUssSUFBSSxNQUFNLEVBQUUsQ0FBQztRQUNqQyxNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztJQUNsQyxDQUFDO0lBQ0QsT0FBTyxNQUFNLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDO0FBQy9CLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBTM0NsaWVudCwgR2V0T2JqZWN0Q29tbWFuZCB9IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1zMyc7XG5pbXBvcnQgeyBBUElHYXRld2F5UHJveHlFdmVudFYyLCBBUElHYXRld2F5UHJveHlSZXN1bHRWMiB9IGZyb20gJ2F3cy1sYW1iZGEnO1xuaW1wb3J0IHNoYXJwIGZyb20gJ3NoYXJwJztcblxuY29uc3QgczNDbGllbnQgPSBuZXcgUzNDbGllbnQoe30pO1xuXG50eXBlIE91dHB1dEZvcm1hdCA9ICd3ZWJwJyB8ICdwbmcnIHwgJ2pwZWcnIHwgJ2F1dG8nO1xuXG5pbnRlcmZhY2UgUmVzaXplUGFyYW1zIHtcbiAgd2lkdGg/OiBudW1iZXI7XG4gIGhlaWdodD86IG51bWJlcjtcbiAgcmFkaXVzPzogbnVtYmVyO1xuICBxdWFsaXR5PzogbnVtYmVyO1xuICBmb3JtYXQ/OiBPdXRwdXRGb3JtYXQ7XG59XG5cbmZ1bmN0aW9uIHBhcnNlUXVlcnlQYXJhbXMocXVlcnlQYXJhbXM6IFJlY29yZDxzdHJpbmcsIHN0cmluZyB8IHVuZGVmaW5lZD4pOiBSZXNpemVQYXJhbXMge1xuICBjb25zdCBmb3JtYXQgPSBxdWVyeVBhcmFtcy5mPy50b0xvd2VyQ2FzZSgpO1xuICByZXR1cm4ge1xuICAgIHdpZHRoOiBxdWVyeVBhcmFtcy53ID8gcGFyc2VJbnQocXVlcnlQYXJhbXMudywgMTApIDogdW5kZWZpbmVkLFxuICAgIGhlaWdodDogcXVlcnlQYXJhbXMuaCA/IHBhcnNlSW50KHF1ZXJ5UGFyYW1zLmgsIDEwKSA6IHVuZGVmaW5lZCxcbiAgICByYWRpdXM6IHF1ZXJ5UGFyYW1zLnIgPyBwYXJzZUludChxdWVyeVBhcmFtcy5yLCAxMCkgOiB1bmRlZmluZWQsXG4gICAgcXVhbGl0eTogcXVlcnlQYXJhbXMucSA/IHBhcnNlSW50KHF1ZXJ5UGFyYW1zLnEsIDEwKSA6IDgwLFxuICAgIGZvcm1hdDogKGZvcm1hdCA9PT0gJ3dlYnAnIHx8IGZvcm1hdCA9PT0gJ3BuZycgfHwgZm9ybWF0ID09PSAnanBlZycpID8gZm9ybWF0IDogJ2F1dG8nLFxuICB9O1xufVxuXG5leHBvcnQgY29uc3QgaGFuZGxlciA9IGFzeW5jIChcbiAgZXZlbnQ6IEFQSUdhdGV3YXlQcm94eUV2ZW50VjJcbik6IFByb21pc2U8QVBJR2F0ZXdheVByb3h5UmVzdWx0VjI+ID0+IHtcbiAgdHJ5IHtcbiAgICBjb25zdCBidWNrZXROYW1lID0gcHJvY2Vzcy5lbnYuQlVDS0VUX05BTUU7XG4gICAgY29uc3Qga2V5ID0gZXZlbnQucGF0aFBhcmFtZXRlcnM/LnByb3h5IHx8IGV2ZW50LnJhd1BhdGgucmVwbGFjZSgvXlxcLy8sICcnKTtcblxuICAgIGlmICghYnVja2V0TmFtZSB8fCAha2V5KSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBzdGF0dXNDb2RlOiA0MDAsXG4gICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHsgZXJyb3I6ICdNaXNzaW5nIGJ1Y2tldCBvciBrZXknIH0pLFxuICAgICAgfTtcbiAgICB9XG5cbiAgICBjb25zdCBwYXJhbXMgPSBwYXJzZVF1ZXJ5UGFyYW1zKGV2ZW50LnF1ZXJ5U3RyaW5nUGFyYW1ldGVycyB8fCB7fSk7XG5cbiAgICAvLyBJZiBubyByZXNpemUgcGFyYW1ldGVycywgcmV0dXJuIG9yaWdpbmFsXG4gICAgaWYgKCFwYXJhbXMud2lkdGggJiYgIXBhcmFtcy5oZWlnaHQgJiYgIXBhcmFtcy5yYWRpdXMpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHN0YXR1c0NvZGU6IDMwMixcbiAgICAgICAgaGVhZGVyczoge1xuICAgICAgICAgIExvY2F0aW9uOiBgaHR0cHM6Ly8ke2J1Y2tldE5hbWV9LnMzLmFtYXpvbmF3cy5jb20vJHtrZXl9YCxcbiAgICAgICAgfSxcbiAgICAgICAgYm9keTogJycsXG4gICAgICB9O1xuICAgIH1cblxuICAgIC8vIEdldCBvcmlnaW5hbCBpbWFnZSBmcm9tIFMzXG4gICAgY29uc3QgZ2V0Q29tbWFuZCA9IG5ldyBHZXRPYmplY3RDb21tYW5kKHtcbiAgICAgIEJ1Y2tldDogYnVja2V0TmFtZSxcbiAgICAgIEtleToga2V5LFxuICAgIH0pO1xuXG4gICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBzM0NsaWVudC5zZW5kKGdldENvbW1hbmQpO1xuICAgIGNvbnN0IGltYWdlQnVmZmVyID0gYXdhaXQgc3RyZWFtVG9CdWZmZXIocmVzcG9uc2UuQm9keSBhcyBOb2RlSlMuUmVhZGFibGVTdHJlYW0pO1xuXG4gICAgLy8gUHJvY2VzcyBpbWFnZSB3aXRoIHNoYXJwXG4gICAgbGV0IHNoYXJwSW5zdGFuY2UgPSBzaGFycChpbWFnZUJ1ZmZlcik7XG5cbiAgICAvLyBSZXNpemVcbiAgICBpZiAocGFyYW1zLndpZHRoIHx8IHBhcmFtcy5oZWlnaHQpIHtcbiAgICAgIHNoYXJwSW5zdGFuY2UgPSBzaGFycEluc3RhbmNlLnJlc2l6ZShwYXJhbXMud2lkdGgsIHBhcmFtcy5oZWlnaHQsIHtcbiAgICAgICAgZml0OiAnaW5zaWRlJyxcbiAgICAgICAgd2l0aG91dEVubGFyZ2VtZW50OiB0cnVlLFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgLy8gQXBwbHkgcm91bmRlZCBjb3JuZXJzXG4gICAgaWYgKHBhcmFtcy5yYWRpdXMgJiYgcGFyYW1zLnJhZGl1cyA+IDApIHtcbiAgICAgIGNvbnN0IG1ldGFkYXRhID0gYXdhaXQgc2hhcnAoaW1hZ2VCdWZmZXIpLm1ldGFkYXRhKCk7XG4gICAgICBjb25zdCB3aWR0aCA9IHBhcmFtcy53aWR0aCB8fCBtZXRhZGF0YS53aWR0aCB8fCAxMDA7XG4gICAgICBjb25zdCBoZWlnaHQgPSBwYXJhbXMuaGVpZ2h0IHx8IG1ldGFkYXRhLmhlaWdodCB8fCAxMDA7XG5cbiAgICAgIGNvbnN0IHJvdW5kZWRDb3JuZXJzID0gQnVmZmVyLmZyb20oXG4gICAgICAgIGA8c3ZnPjxyZWN0IHg9XCIwXCIgeT1cIjBcIiB3aWR0aD1cIiR7d2lkdGh9XCIgaGVpZ2h0PVwiJHtoZWlnaHR9XCIgcng9XCIke3BhcmFtcy5yYWRpdXN9XCIgcnk9XCIke3BhcmFtcy5yYWRpdXN9XCIvPjwvc3ZnPmBcbiAgICAgICk7XG5cbiAgICAgIHNoYXJwSW5zdGFuY2UgPSBzaGFycEluc3RhbmNlLmNvbXBvc2l0ZShbXG4gICAgICAgIHtcbiAgICAgICAgICBpbnB1dDogcm91bmRlZENvcm5lcnMsXG4gICAgICAgICAgYmxlbmQ6ICdkZXN0LWluJyxcbiAgICAgICAgfSxcbiAgICAgIF0pO1xuICAgIH1cblxuICAgIC8vIERldGVybWluZSBvdXRwdXQgZm9ybWF0XG4gICAgLy8gSWYgcmFkaXVzIGlzIGFwcGxpZWQsIHVzZSBQTkcgKHN1cHBvcnRzIHRyYW5zcGFyZW5jeSkgdW5sZXNzIGV4cGxpY2l0bHkgc3BlY2lmaWVkXG4gICAgbGV0IG91dHB1dEZvcm1hdDogT3V0cHV0Rm9ybWF0ID0gcGFyYW1zLmZvcm1hdCB8fCAnYXV0byc7XG4gICAgaWYgKG91dHB1dEZvcm1hdCA9PT0gJ2F1dG8nKSB7XG4gICAgICBvdXRwdXRGb3JtYXQgPSBwYXJhbXMucmFkaXVzICYmIHBhcmFtcy5yYWRpdXMgPiAwID8gJ3BuZycgOiAnd2VicCc7XG4gICAgfVxuXG4gICAgLy8gQ29udmVydCB0byBzcGVjaWZpZWQgZm9ybWF0XG4gICAgbGV0IG91dHB1dEJ1ZmZlcjogQnVmZmVyO1xuICAgIGxldCBjb250ZW50VHlwZTogc3RyaW5nO1xuXG4gICAgc3dpdGNoIChvdXRwdXRGb3JtYXQpIHtcbiAgICAgIGNhc2UgJ3BuZyc6XG4gICAgICAgIG91dHB1dEJ1ZmZlciA9IGF3YWl0IHNoYXJwSW5zdGFuY2UucG5nKHsgcXVhbGl0eTogcGFyYW1zLnF1YWxpdHkgfSkudG9CdWZmZXIoKTtcbiAgICAgICAgY29udGVudFR5cGUgPSAnaW1hZ2UvcG5nJztcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdqcGVnJzpcbiAgICAgICAgb3V0cHV0QnVmZmVyID0gYXdhaXQgc2hhcnBJbnN0YW5jZS5qcGVnKHsgcXVhbGl0eTogcGFyYW1zLnF1YWxpdHkgfSkudG9CdWZmZXIoKTtcbiAgICAgICAgY29udGVudFR5cGUgPSAnaW1hZ2UvanBlZyc7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAnd2VicCc6XG4gICAgICBkZWZhdWx0OlxuICAgICAgICBvdXRwdXRCdWZmZXIgPSBhd2FpdCBzaGFycEluc3RhbmNlLndlYnAoeyBxdWFsaXR5OiBwYXJhbXMucXVhbGl0eSB9KS50b0J1ZmZlcigpO1xuICAgICAgICBjb250ZW50VHlwZSA9ICdpbWFnZS93ZWJwJztcbiAgICAgICAgYnJlYWs7XG4gICAgfVxuXG4gICAgcmV0dXJuIHtcbiAgICAgIHN0YXR1c0NvZGU6IDIwMCxcbiAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgJ0NvbnRlbnQtVHlwZSc6IGNvbnRlbnRUeXBlLFxuICAgICAgICAnQ2FjaGUtQ29udHJvbCc6ICdwdWJsaWMsIG1heC1hZ2U9MzE1MzYwMDAnLFxuICAgICAgfSxcbiAgICAgIGJvZHk6IG91dHB1dEJ1ZmZlci50b1N0cmluZygnYmFzZTY0JyksXG4gICAgICBpc0Jhc2U2NEVuY29kZWQ6IHRydWUsXG4gICAgfTtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBjb25zb2xlLmVycm9yKCdFcnJvciBwcm9jZXNzaW5nIGltYWdlOicsIGVycm9yKTtcbiAgICByZXR1cm4ge1xuICAgICAgc3RhdHVzQ29kZTogNTAwLFxuICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoeyBlcnJvcjogJ0ltYWdlIHByb2Nlc3NpbmcgZmFpbGVkJyB9KSxcbiAgICB9O1xuICB9XG59O1xuXG5hc3luYyBmdW5jdGlvbiBzdHJlYW1Ub0J1ZmZlcihzdHJlYW06IE5vZGVKUy5SZWFkYWJsZVN0cmVhbSk6IFByb21pc2U8QnVmZmVyPiB7XG4gIGNvbnN0IGNodW5rczogQnVmZmVyW10gPSBbXTtcbiAgZm9yIGF3YWl0IChjb25zdCBjaHVuayBvZiBzdHJlYW0pIHtcbiAgICBjaHVua3MucHVzaChCdWZmZXIuZnJvbShjaHVuaykpO1xuICB9XG4gIHJldHVybiBCdWZmZXIuY29uY2F0KGNodW5rcyk7XG59XG4iXX0=