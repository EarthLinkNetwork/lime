"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_s3_1 = require("@aws-sdk/client-s3");
const s3Client = new client_s3_1.S3Client({});
const BUCKET_NAME = process.env.BUCKET_NAME;
const VALID_API_KEYS = (process.env.VALID_API_KEYS || '').split(',').filter(Boolean);
const DEFAULT_LIMIT = 50;
// CORS headers for all responses
const corsHeaders = {
    'Content-Type': 'application/json',
    'Access-Control-Allow-Origin': '*',
    'Access-Control-Allow-Headers': 'Content-Type, X-Api-Key',
};
const handler = async (event) => {
    try {
        // API Key validation
        const apiKey = event.headers['x-api-key'];
        if (!apiKey) {
            return {
                statusCode: 403,
                headers: corsHeaders,
                body: JSON.stringify({ error: 'Forbidden: API Key required' }),
            };
        }
        if (VALID_API_KEYS.length > 0 && !VALID_API_KEYS.includes(apiKey)) {
            return {
                statusCode: 403,
                headers: corsHeaders,
                body: JSON.stringify({ error: 'Forbidden: Invalid API Key' }),
            };
        }
        // Parse query parameters
        const params = event.queryStringParameters || {};
        const { projectCode, ownerKey, folder, limit, cursor, includeTags } = params;
        if (!projectCode) {
            return {
                statusCode: 400,
                headers: corsHeaders,
                body: JSON.stringify({ error: 'projectCode is required' }),
            };
        }
        // Build prefix
        let prefix = `${projectCode}/`;
        if (ownerKey) {
            prefix += `${ownerKey}/`;
            if (folder) {
                prefix += `${folder}/`;
            }
        }
        // List objects
        const listCommand = new client_s3_1.ListObjectsV2Command({
            Bucket: BUCKET_NAME,
            Prefix: prefix,
            MaxKeys: limit ? parseInt(limit, 10) : DEFAULT_LIMIT,
            ContinuationToken: cursor || undefined,
        });
        const listResult = await s3Client.send(listCommand);
        const contents = listResult.Contents || [];
        // Build objects array
        const objects = await Promise.all(contents.map(async (item) => {
            const obj = {
                key: item.Key,
                size: item.Size,
                lastModified: item.LastModified?.toISOString(),
            };
            // Fetch tags if requested
            if (includeTags === 'true' && item.Key) {
                const taggingCommand = new client_s3_1.GetObjectTaggingCommand({
                    Bucket: BUCKET_NAME,
                    Key: item.Key,
                });
                const taggingResult = await s3Client.send(taggingCommand);
                const tags = {};
                for (const tag of taggingResult.TagSet || []) {
                    if (tag.Key && tag.Value) {
                        tags[tag.Key] = tag.Value;
                    }
                }
                obj.tags = tags;
            }
            return obj;
        }));
        return {
            statusCode: 200,
            headers: corsHeaders,
            body: JSON.stringify({
                objects,
                nextCursor: listResult.IsTruncated ? listResult.NextContinuationToken : null,
            }),
        };
    }
    catch (error) {
        console.error('Error listing objects:', error);
        return {
            statusCode: 500,
            headers: corsHeaders,
            body: JSON.stringify({ error: 'Internal server error' }),
        };
    }
};
exports.handler = handler;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9sYW1iZGEvbGlzdC1vYmplY3RzL2luZGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLGtEQUE2RjtBQUc3RixNQUFNLFFBQVEsR0FBRyxJQUFJLG9CQUFRLENBQUMsRUFBRSxDQUFDLENBQUM7QUFDbEMsTUFBTSxXQUFXLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxXQUFZLENBQUM7QUFDN0MsTUFBTSxjQUFjLEdBQUcsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLGNBQWMsSUFBSSxFQUFFLENBQUMsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0FBRXJGLE1BQU0sYUFBYSxHQUFHLEVBQUUsQ0FBQztBQUV6QixpQ0FBaUM7QUFDakMsTUFBTSxXQUFXLEdBQUc7SUFDbEIsY0FBYyxFQUFFLGtCQUFrQjtJQUNsQyw2QkFBNkIsRUFBRSxHQUFHO0lBQ2xDLDhCQUE4QixFQUFFLHlCQUF5QjtDQUMxRCxDQUFDO0FBRUssTUFBTSxPQUFPLEdBQUcsS0FBSyxFQUMxQixLQUE2QixFQUNLLEVBQUU7SUFDcEMsSUFBSSxDQUFDO1FBQ0gscUJBQXFCO1FBQ3JCLE1BQU0sTUFBTSxHQUFHLEtBQUssQ0FBQyxPQUFPLENBQUMsV0FBVyxDQUFDLENBQUM7UUFDMUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDO1lBQ1osT0FBTztnQkFDTCxVQUFVLEVBQUUsR0FBRztnQkFDZixPQUFPLEVBQUUsV0FBVztnQkFDcEIsSUFBSSxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsRUFBRSxLQUFLLEVBQUUsNkJBQTZCLEVBQUUsQ0FBQzthQUMvRCxDQUFDO1FBQ0osQ0FBQztRQUVELElBQUksY0FBYyxDQUFDLE1BQU0sR0FBRyxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUM7WUFD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QyxDQUNILENBQUM7UUFFRixPQUFPO1lBQ0wsVUFBVSxFQUFFLEdBQUc7WUFDZixPQUFPLEVBQUUsV0FBVztZQUNwQixJQUFJLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQztnQkFDbkIsT0FBTztnQkFDUCxVQUFVLEVBQUUsVUFBVSxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMsVUFBVSxDQUFDLHFCQUFxQixDQUFDLENBQUMsQ0FBQyxJQUFJO2FBQzdFLENBQUM7U0FDSCxDQUFDO0lBQ0osQ0FBQztJQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7UUFDZixPQUFPLENBQUMsS0FBSyxDQUFDLHdCQUF3QixFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQy9DLE9BQU87WUFDTCxVQUFVLEVBQUUsR0FBRztZQUNmLE9BQU8sRUFBRSxXQUFXO1lBQ3BCLElBQUksRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLEVBQUUsS0FBSyxFQUFFLHVCQUF1QixFQUFFLENBQUM7U0FDekQsQ0FBQztJQUNKLENBQUM7QUFDSCxDQUFDLENBQUM7QUFwR1csUUFBQSxPQUFPLFdBb0dsQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFMzQ2xpZW50LCBMaXN0T2JqZWN0c1YyQ29tbWFuZCwgR2V0T2JqZWN0VGFnZ2luZ0NvbW1hbmQgfSBmcm9tICdAYXdzLXNkay9jbGllbnQtczMnO1xuaW1wb3J0IHsgQVBJR2F0ZXdheVByb3h5RXZlbnRWMiwgQVBJR2F0ZXdheVByb3h5UmVzdWx0VjIgfSBmcm9tICdhd3MtbGFtYmRhJztcblxuY29uc3QgczNDbGllbnQgPSBuZXcgUzNDbGllbnQoe30pO1xuY29uc3QgQlVDS0VUX05BTUUgPSBwcm9jZXNzLmVudi5CVUNLRVRfTkFNRSE7XG5jb25zdCBWQUxJRF9BUElfS0VZUyA9IChwcm9jZXNzLmVudi5WQUxJRF9BUElfS0VZUyB8fCAnJykuc3BsaXQoJywnKS5maWx0ZXIoQm9vbGVhbik7XG5cbmNvbnN0IERFRkFVTFRfTElNSVQgPSA1MDtcblxuLy8gQ09SUyBoZWFkZXJzIGZvciBhbGwgcmVzcG9uc2VzXG5jb25zdCBjb3JzSGVhZGVycyA9IHtcbiAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJyxcbiAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LU9yaWdpbic6ICcqJyxcbiAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LUhlYWRlcnMnOiAnQ29udGVudC1UeXBlLCBYLUFwaS1LZXknLFxufTtcblxuZXhwb3J0IGNvbnN0IGhhbmRsZXIgPSBhc3luYyAoXG4gIGV2ZW50OiBBUElHYXRld2F5UHJveHlFdmVudFYyXG4pOiBQcm9taXNlPEFQSUdhdGV3YXlQcm94eVJlc3VsdFYyPiA9PiB7XG4gIHRyeSB7XG4gICAgLy8gQVBJIEtleSB2YWxpZGF0aW9uXG4gICAgY29uc3QgYXBpS2V5ID0gZXZlbnQuaGVhZGVyc1sneC1hcGkta2V5J107XG4gICAgaWYgKCFhcGlLZXkpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHN0YXR1c0NvZGU6IDQwMyxcbiAgICAgICAgaGVhZGVyczogY29yc0hlYWRlcnMsXG4gICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHsgZXJyb3I6ICdGb3JiaWRkZW46IEFQSSBLZXkgcmVxdWlyZWQnIH0pLFxuICAgICAgfTtcbiAgICB9XG5cbiAgICBpZiAoVkFMSURfQVBJX0tFWVMubGVuZ3RoID4gMCAmJiAhVkFMSURfQVBJX0tFWVMuaW5jbHVkZXMoYXBpS2V5KSkge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgc3RhdHVzQ29kZTogNDAzLFxuICAgICAgICBoZWFkZXJzOiBjb3JzSGVhZGVycyxcbiAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoeyBlcnJvcjogJ0ZvcmJpZGRlbjogSW52YWxpZCBBUEkgS2V5JyB9KSxcbiAgICAgIH07XG4gICAgfVxuXG4gICAgLy8gUGFyc2UgcXVlcnkgcGFyYW1ldGVyc1xuICAgIGNvbnN0IHBhcmFtcyA9IGV2ZW50LnF1ZXJ5U3RyaW5nUGFyYW1ldGVycyB8fCB7fTtcbiAgICBjb25zdCB7IHByb2plY3RDb2RlLCBvd25lcktleSwgZm9sZGVyLCBsaW1pdCwgY3Vyc29yLCBpbmNsdWRlVGFncyB9ID0gcGFyYW1zO1xuXG4gICAgaWYgKCFwcm9qZWN0Q29kZSkge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgc3RhdHVzQ29kZTogNDAwLFxuICAgICAgICBoZWFkZXJzOiBjb3JzSGVhZGVycyxcbiAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoeyBlcnJvcjogJ3Byb2plY3RDb2RlIGlzIHJlcXVpcmVkJyB9KSxcbiAgICAgIH07XG4gICAgfVxuXG4gICAgLy8gQnVpbGQgcHJlZml4XG4gICAgbGV0IHByZWZpeCA9IGAke3Byb2plY3RDb2RlfS9gO1xuICAgIGlmIChvd25lcktleSkge1xuICAgICAgcHJlZml4ICs9IGAke293bmVyS2V5fS9gO1xuICAgICAgaWYgKGZvbGRlcikge1xuICAgICAgICBwcmVmaXggKz0gYCR7Zm9sZGVyfS9gO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIExpc3Qgb2JqZWN0c1xuICAgIGNvbnN0IGxpc3RDb21tYW5kID0gbmV3IExpc3RPYmplY3RzVjJDb21tYW5kKHtcbiAgICAgIEJ1Y2tldDogQlVDS0VUX05BTUUsXG4gICAgICBQcmVmaXg6IHByZWZpeCxcbiAgICAgIE1heEtleXM6IGxpbWl0ID8gcGFyc2VJbnQobGltaXQsIDEwKSA6IERFRkFVTFRfTElNSVQsXG4gICAgICBDb250aW51YXRpb25Ub2tlbjogY3Vyc29yIHx8IHVuZGVmaW5lZCxcbiAgICB9KTtcblxuICAgIGNvbnN0IGxpc3RSZXN1bHQgPSBhd2FpdCBzM0NsaWVudC5zZW5kKGxpc3RDb21tYW5kKTtcblxuICAgIGNvbnN0IGNvbnRlbnRzID0gbGlzdFJlc3VsdC5Db250ZW50cyB8fCBbXTtcblxuICAgIC8vIEJ1aWxkIG9iamVjdHMgYXJyYXlcbiAgICBjb25zdCBvYmplY3RzID0gYXdhaXQgUHJvbWlzZS5hbGwoXG4gICAgICBjb250ZW50cy5tYXAoYXN5bmMgKGl0ZW0pID0+IHtcbiAgICAgICAgY29uc3Qgb2JqOiBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPiA9IHtcbiAgICAgICAgICBrZXk6IGl0ZW0uS2V5LFxuICAgICAgICAgIHNpemU6IGl0ZW0uU2l6ZSxcbiAgICAgICAgICBsYXN0TW9kaWZpZWQ6IGl0ZW0uTGFzdE1vZGlmaWVkPy50b0lTT1N0cmluZygpLFxuICAgICAgICB9O1xuXG4gICAgICAgIC8vIEZldGNoIHRhZ3MgaWYgcmVxdWVzdGVkXG4gICAgICAgIGlmIChpbmNsdWRlVGFncyA9PT0gJ3RydWUnICYmIGl0ZW0uS2V5KSB7XG4gICAgICAgICAgY29uc3QgdGFnZ2luZ0NvbW1hbmQgPSBuZXcgR2V0T2JqZWN0VGFnZ2luZ0NvbW1hbmQoe1xuICAgICAgICAgICAgQnVja2V0OiBCVUNLRVRfTkFNRSxcbiAgICAgICAgICAgIEtleTogaXRlbS5LZXksXG4gICAgICAgICAgfSk7XG4gICAgICAgICAgY29uc3QgdGFnZ2luZ1Jlc3VsdCA9IGF3YWl0IHMzQ2xpZW50LnNlbmQodGFnZ2luZ0NvbW1hbmQpO1xuICAgICAgICAgIGNvbnN0IHRhZ3M6IFJlY29yZDxzdHJpbmcsIHN0cmluZz4gPSB7fTtcbiAgICAgICAgICBmb3IgKGNvbnN0IHRhZyBvZiB0YWdnaW5nUmVzdWx0LlRhZ1NldCB8fCBbXSkge1xuICAgICAgICAgICAgaWYgKHRhZy5LZXkgJiYgdGFnLlZhbHVlKSB7XG4gICAgICAgICAgICAgIHRhZ3NbdGFnLktleV0gPSB0YWcuVmFsdWU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICAgIG9iai50YWdzID0gdGFncztcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBvYmo7XG4gICAgICB9KVxuICAgICk7XG5cbiAgICByZXR1cm4ge1xuICAgICAgc3RhdHVzQ29kZTogMjAwLFxuICAgICAgaGVhZGVyczogY29yc0hlYWRlcnMsXG4gICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgIG9iamVjdHMsXG4gICAgICAgIG5leHRDdXJzb3I6IGxpc3RSZXN1bHQuSXNUcnVuY2F0ZWQgPyBsaXN0UmVzdWx0Lk5leHRDb250aW51YXRpb25Ub2tlbiA6IG51bGwsXG4gICAgICB9KSxcbiAgICB9O1xuICB9IGNhdGNoIChlcnJvcikge1xuICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIGxpc3Rpbmcgb2JqZWN0czonLCBlcnJvcik7XG4gICAgcmV0dXJuIHtcbiAgICAgIHN0YXR1c0NvZGU6IDUwMCxcbiAgICAgIGhlYWRlcnM6IGNvcnNIZWFkZXJzLFxuICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoeyBlcnJvcjogJ0ludGVybmFsIHNlcnZlciBlcnJvcicgfSksXG4gICAgfTtcbiAgfVxufTtcbiJdfQ==