"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
// Mock AWS SDK
const mockGetSignedUrl = jest.fn().mockResolvedValue('https://s3.example.com/presigned-url');
const mockS3Client = jest.fn();
jest.mock('@aws-sdk/client-s3', () => ({
    S3Client: jest.fn().mockImplementation(() => mockS3Client),
    PutObjectCommand: jest.fn().mockImplementation((params) => params),
}));
jest.mock('@aws-sdk/s3-request-presigner', () => ({
    getSignedUrl: mockGetSignedUrl,
}));
jest.mock('crypto', () => ({
    randomUUID: jest.fn().mockReturnValue('test-uuid-1234'),
}));
// Set env before importing handler
process.env.BUCKET_NAME = 'test-bucket';
process.env.VALID_API_KEYS = ''; // Empty = accept any key (development mode)
// Import handler after mocks
const index_1 = require("../../lambda/presigned-url/index");
describe('Presigned URL Lambda', () => {
    const createEvent = (overrides = {}) => ({
        version: '2.0',
        routeKey: 'POST /presigned-url',
        rawPath: '/presigned-url',
        rawQueryString: '',
        headers: {
            'content-type': 'application/json',
            'x-api-key': 'valid-api-key',
            ...overrides.headers,
        },
        requestContext: {
            accountId: '123456789012',
            apiId: 'test-api-id',
            domainName: 'test.execute-api.ap-northeast-1.amazonaws.com',
            domainPrefix: 'test',
            http: {
                method: 'POST',
                path: '/presigned-url',
                protocol: 'HTTP/1.1',
                sourceIp: '127.0.0.1',
                userAgent: 'test-agent',
            },
            requestId: 'test-request-id',
            routeKey: 'POST /presigned-url',
            stage: '$default',
            time: '01/Jan/2024:00:00:00 +0000',
            timeEpoch: 1704067200000,
        },
        body: JSON.stringify({
            fileName: 'test.jpg',
            contentType: 'image/jpeg',
        }),
        isBase64Encoded: false,
        ...overrides,
    });
    beforeEach(() => {
        jest.clearAllMocks();
    });
    describe('AC1: API Key Validation - 403 Forbidden', () => {
        it('API Keyがない場合、403 Forbiddenを返すこと', async () => {
            const event = createEvent({
                headers: {
                    'content-type': 'application/json',
                    // x-api-key is missing
                },
            });
            const result = await (0, index_1.handler)(event);
            expect(result.statusCode).toBe(403);
            expect(JSON.parse(result.body)).toEqual({
                error: 'Forbidden: API Key required',
            });
        });
        it('API Keyが空文字の場合、403 Forbiddenを返すこと', async () => {
            const event = createEvent({
                headers: {
                    'content-type': 'application/json',
                    'x-api-key': '',
                },
            });
            const result = await (0, index_1.handler)(event);
            expect(result.statusCode).toBe(403);
        });
        it('有効なAPI Keyがある場合、403を返さないこと', async () => {
            const event = createEvent();
            const result = await (0, index_1.handler)(event);
            expect(result.statusCode).not.toBe(403);
        });
    });
    describe('AC2: Presigned URL Generation with putObject permission', () => {
        it('正常なリクエストで署名付きURLを発行すること', async () => {
            const event = createEvent();
            const result = await (0, index_1.handler)(event);
            expect(result.statusCode).toBe(200);
            const body = JSON.parse(result.body);
            expect(body).toHaveProperty('uploadUrl');
            expect(body).toHaveProperty('key');
            expect(body).toHaveProperty('fileUrl');
        });
        it('PutObjectCommandがS3バケットとキーで呼ばれること', async () => {
            const { PutObjectCommand } = require('@aws-sdk/client-s3');
            const event = createEvent();
            await (0, index_1.handler)(event);
            expect(PutObjectCommand).toHaveBeenCalledWith(expect.objectContaining({
                Bucket: 'test-bucket',
                Key: expect.stringContaining('uploads/'),
                ContentType: 'image/jpeg',
            }));
        });
        it('getSignedUrlがPUT用に呼ばれること', async () => {
            const event = createEvent();
            await (0, index_1.handler)(event);
            expect(mockGetSignedUrl).toHaveBeenCalledWith(expect.anything(), expect.objectContaining({
                Bucket: 'test-bucket',
                ContentType: 'image/jpeg',
            }), { expiresIn: 3600 });
        });
        it('カスタムフォルダが指定された場合、そのフォルダにキーが生成されること', async () => {
            const { PutObjectCommand } = require('@aws-sdk/client-s3');
            const event = createEvent({
                body: JSON.stringify({
                    fileName: 'test.jpg',
                    contentType: 'image/jpeg',
                    folder: 'custom-folder',
                }),
            });
            await (0, index_1.handler)(event);
            expect(PutObjectCommand).toHaveBeenCalledWith(expect.objectContaining({
                Key: expect.stringContaining('custom-folder/'),
            }));
        });
    });
    describe('Validation', () => {
        it('リクエストボディがない場合、400を返すこと', async () => {
            const event = createEvent({ body: undefined });
            const result = await (0, index_1.handler)(event);
            expect(result.statusCode).toBe(400);
            expect(JSON.parse(result.body)).toEqual({
                error: 'Request body is required',
            });
        });
        it('fileNameがない場合、400を返すこと', async () => {
            const event = createEvent({
                body: JSON.stringify({ contentType: 'image/jpeg' }),
            });
            const result = await (0, index_1.handler)(event);
            expect(result.statusCode).toBe(400);
            expect(JSON.parse(result.body)).toEqual({
                error: 'fileName and contentType are required',
            });
        });
        it('contentTypeがない場合、400を返すこと', async () => {
            const event = createEvent({
                body: JSON.stringify({ fileName: 'test.jpg' }),
            });
            const result = await (0, index_1.handler)(event);
            expect(result.statusCode).toBe(400);
        });
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJlc2lnbmVkLXVybC50ZXN0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vdGVzdC9sYW1iZGEvcHJlc2lnbmVkLXVybC50ZXN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBTUEsZUFBZTtBQUNmLE1BQU0sZ0JBQWdCLEdBQUcsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLGlCQUFpQixDQUFDLHNDQUFzQyxDQUFDLENBQUM7QUFDN0YsTUFBTSxZQUFZLEdBQUcsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDO0FBRS9CLElBQUksQ0FBQyxJQUFJLENBQUMsb0JBQW9CLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQztJQUNyQyxRQUFRLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLGtCQUFrQixDQUFDLEdBQUcsRUFBRSxDQUFDLFlBQVksQ0FBQztJQUMxRCxnQkFBZ0IsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsa0JBQWtCLENBQUMsQ0FBQyxNQUFNLEVBQUUsRUFBRSxDQUFDLE1BQU0sQ0FBQztDQUNuRSxDQUFDLENBQUMsQ0FBQztBQUVKLElBQUksQ0FBQyxJQUFJLENBQUMsK0JBQStCLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQztJQUNoRCxZQUFZLEVBQUUsZ0JBQWdCO0NBQy9CLENBQUMsQ0FBQyxDQUFDO0FBRUosSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQztJQUN6QixVQUFVLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLGVBQWUsQ0FBQyxnQkFBZ0IsQ0FBQztDQUN4RCxDQUFDLENBQUMsQ0FBQztBQUVKLG1DQUFtQztBQUNuQyxPQUFPLENBQUMsR0FBRyxDQUFDLFdBQVcsR0FBRyxhQUFhLENBQUM7QUFDeEMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxjQUFjLEdBQUcsRUFBRSxDQUFDLENBQUMsNENBQTRDO0FBRTdFLDZCQUE2QjtBQUM3Qiw0REFB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SCxNQUFNLE1BQU0sR0FBRyxNQUFNLElBQUEsZUFBTyxFQUFDLEtBQUssQ0FBc0MsQ0FBQztZQUV6RSxNQUFNLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUN0QyxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEFDMTogQVBJIEtleeaknOiovOODhuOCueODiCAtIOacieWKueOBqkFQSSBLZXnjgYzjgarjgYTjg6rjgq/jgqjjgrnjg4jjga80MDMgRm9yYmlkZGVu44KS6L+U44GZ44GT44GoXG4gKiBBQzI6IExhbWJkYSBwdXRPYmplY3TmqKnpmZDjg4bjgrnjg4ggLSBTM+OBrnB1dE9iamVjdOaoqemZkOOCkuaMgeOBpOe9suWQjeS7mOOBjVVSTOOCkuato+W4uOOBq+eZuuihjOOBmeOCi+OBk+OBqFxuICovXG5pbXBvcnQgeyBBUElHYXRld2F5UHJveHlFdmVudFYyLCBBUElHYXRld2F5UHJveHlTdHJ1Y3R1cmVkUmVzdWx0VjIgfSBmcm9tICdhd3MtbGFtYmRhJztcblxuLy8gTW9jayBBV1MgU0RLXG5jb25zdCBtb2NrR2V0U2lnbmVkVXJsID0gamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKCdodHRwczovL3MzLmV4YW1wbGUuY29tL3ByZXNpZ25lZC11cmwnKTtcbmNvbnN0IG1vY2tTM0NsaWVudCA9IGplc3QuZm4oKTtcblxuamVzdC5tb2NrKCdAYXdzLXNkay9jbGllbnQtczMnLCAoKSA9PiAoe1xuICBTM0NsaWVudDogamVzdC5mbigpLm1vY2tJbXBsZW1lbnRhdGlvbigoKSA9PiBtb2NrUzNDbGllbnQpLFxuICBQdXRPYmplY3RDb21tYW5kOiBqZXN0LmZuKCkubW9ja0ltcGxlbWVudGF0aW9uKChwYXJhbXMpID0+IHBhcmFtcyksXG59KSk7XG5cbmplc3QubW9jaygnQGF3cy1zZGsvczMtcmVxdWVzdC1wcmVzaWduZXInLCAoKSA9PiAoe1xuICBnZXRTaWduZWRVcmw6IG1vY2tHZXRTaWduZWRVcmwsXG59KSk7XG5cbmplc3QubW9jaygnY3J5cHRvJywgKCkgPT4gKHtcbiAgcmFuZG9tVVVJRDogamVzdC5mbigpLm1vY2tSZXR1cm5WYWx1ZSgndGVzdC11dWlkLTEyMzQnKSxcbn0pKTtcblxuLy8gU2V0IGVudiBiZWZvcmUgaW1wb3J0aW5nIGhhbmRsZXJcbnByb2Nlc3MuZW52LkJVQ0tFVF9OQU1FID0gJ3Rlc3QtYnVja2V0JztcbnByb2Nlc3MuZW52LlZBTElEX0FQSV9LRVlTID0gJyc7IC8vIEVtcHR5ID0gYWNjZXB0IGFueSBrZXkgKGRldmVsb3BtZW50IG1vZGUpXG5cbi8vIEltcG9ydCBoYW5kbGVyIGFmdGVyIG1vY2tzXG5pbXBvcnQgeyBoYW5kbGVyIH0gZnJvbSAnLi4vLi4vbGFtYmRhL3ByZXNpZ25lZC11cmwvaW5kZXgnO1xuXG5kZXNjcmliZSgnUHJlc2lnbmVkIFVSTCBMYW1iZGEnLCAoKSA9PiB7XG4gIGNvbnN0IGNyZWF0ZUV2ZW50ID0gKG92ZXJyaWRlczogUGFydGlhbDxBUElHYXRld2F5UHJveHlFdmVudFYyPiA9IHt9KTogQVBJR2F0ZXdheVByb3h5RXZlbnRWMiA9PiAoe1xuICAgIHZlcnNpb246ICcyLjAnLFxuICAgIHJvdXRlS2V5OiAnUE9TVCAvcHJlc2lnbmVkLXVybCcsXG4gICAgcmF3UGF0aDogJy9wcmVzaWduZWQtdXJsJyxcbiAgICByYXdRdWVyeVN0cmluZzogJycsXG4gICAgaGVhZGVyczoge1xuICAgICAgJ2NvbnRlbnQtdHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJyxcbiAgICAgICd4LWFwaS1rZXknOiAndmFsaWQtYXBpLWtleScsXG4gICAgICAuLi5vdmVycmlkZXMuaGVhZGVycyxcbiAgICB9LFxuICAgIHJlcXVlc3RDb250ZXh0OiB7XG4gICAgICBhY2NvdW50SWQ6ICcxMjM0NTY3ODkwMTInLFxuICAgICAgYXBpSWQ6ICd0ZXN0LWFwaS1pZCcsXG4gICAgICBkb21haW5OYW1lOiAndGVzdC5leGVjdXRlLWFwaS5hcC1ub3J0aGVhc3QtMS5hbWF6b25hd3MuY29tJyxcbiAgICAgIGRvbWFpblByZWZpeDogJ3Rlc3QnLFxuICAgICAgaHR0cDoge1xuICAgICAgICBtZXRob2Q6ICdQT1NUJyxcbiAgICAgICAgcGF0aDogJy9wcmVzaWduZWQtdXJsJyxcbiAgICAgICAgcHJvdG9jb2w6ICdIVFRQLzEuMScsXG4gICAgICAgIHNvdXJjZUlwOiAnMTI3LjAuMC4xJyxcbiAgICAgICAgdXNlckFnZW50OiAndGVzdC1hZ2VudCcsXG4gICAgICB9LFxuICAgICAgcmVxdWVzdElkOiAndGVzdC1yZXF1ZXN0LWlkJyxcbiAgICAgIHJvdXRlS2V5OiAnUE9TVCAvcHJlc2lnbmVkLXVybCcsXG4gICAgICBzdGFnZTogJyRkZWZhdWx0JyxcbiAgICAgIHRpbWU6ICcwMS9KYW4vMjAyNDowMDowMDowMCArMDAwMCcsXG4gICAgICB0aW1lRXBvY2g6IDE3MDQwNjcyMDAwMDAsXG4gICAgfSxcbiAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7XG4gICAgICBmaWxlTmFtZTogJ3Rlc3QuanBnJyxcbiAgICAgIGNvbnRlbnRUeXBlOiAnaW1hZ2UvanBlZycsXG4gICAgfSksXG4gICAgaXNCYXNlNjRFbmNvZGVkOiBmYWxzZSxcbiAgICAuLi5vdmVycmlkZXMsXG4gIH0pO1xuXG4gIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgIGplc3QuY2xlYXJBbGxNb2NrcygpO1xuICB9KTtcblxuICBkZXNjcmliZSgnQUMxOiBBUEkgS2V5IFZhbGlkYXRpb24gLSA0MDMgRm9yYmlkZGVuJywgKCkgPT4ge1xuICAgIGl0KCdBUEkgS2V544GM44Gq44GE5aC05ZCI44CBNDAzIEZvcmJpZGRlbuOCkui/lOOBmeOBk+OBqCcsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IGV2ZW50ID0gY3JlYXRlRXZlbnQoe1xuICAgICAgICBoZWFkZXJzOiB7XG4gICAgICAgICAgJ2NvbnRlbnQtdHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJyxcbiAgICAgICAgICAvLyB4LWFwaS1rZXkgaXMgbWlzc2luZ1xuICAgICAgICB9LFxuICAgICAgfSk7XG5cbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGhhbmRsZXIoZXZlbnQpIGFzIEFQSUdhdGV3YXlQcm94eVN0cnVjdHVyZWRSZXN1bHRWMjtcblxuICAgICAgZXhwZWN0KHJlc3VsdC5zdGF0dXNDb2RlKS50b0JlKDQwMyk7XG4gICAgICBleHBlY3QoSlNPTi5wYXJzZShyZXN1bHQuYm9keSBhcyBzdHJpbmcpKS50b0VxdWFsKHtcbiAgICAgICAgZXJyb3I6ICdGb3JiaWRkZW46IEFQSSBLZXkgcmVxdWlyZWQnLFxuICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBpdCgnQVBJIEtleeOBjOepuuaWh+Wtl+OBruWgtOWQiOOAgTQwMyBGb3JiaWRkZW7jgpLov5TjgZnjgZPjgagnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBldmVudCA9IGNyZWF0ZUV2ZW50KHtcbiAgICAgICAgaGVhZGVyczoge1xuICAgICAgICAgICdjb250ZW50LXR5cGUnOiAnYXBwbGljYXRpb24vanNvbicsXG4gICAgICAgICAgJ3gtYXBpLWtleSc6ICcnLFxuICAgICAgICB9LFxuICAgICAgfSk7XG5cbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGhhbmRsZXIoZXZlbnQpIGFzIEFQSUdhdGV3YXlQcm94eVN0cnVjdHVyZWRSZXN1bHRWMjtcblxuICAgICAgZXhwZWN0KHJlc3VsdC5zdGF0dXNDb2RlKS50b0JlKDQwMyk7XG4gICAgfSk7XG5cbiAgICBpdCgn5pyJ5Yq544GqQVBJIEtleeOBjOOBguOCi+WgtOWQiOOAgTQwM+OCkui/lOOBleOBquOBhOOBk+OBqCcsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IGV2ZW50ID0gY3JlYXRlRXZlbnQoKTtcblxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgaGFuZGxlcihldmVudCkgYXMgQVBJR2F0ZXdheVByb3h5U3RydWN0dXJlZFJlc3VsdFYyO1xuXG4gICAgICBleHBlY3QocmVzdWx0LnN0YXR1c0NvZGUpLm5vdC50b0JlKDQwMyk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdBQzI6IFByZXNpZ25lZCBVUkwgR2VuZXJhdGlvbiB3aXRoIHB1dE9iamVjdCBwZXJtaXNzaW9uJywgKCkgPT4ge1xuICAgIGl0KCfmraPluLjjgarjg6rjgq/jgqjjgrnjg4jjgafnvbLlkI3ku5jjgY1VUkzjgpLnmbrooYzjgZnjgovjgZPjgagnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBldmVudCA9IGNyZWF0ZUV2ZW50KCk7XG5cbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGhhbmRsZXIoZXZlbnQpIGFzIEFQSUdhdGV3YXlQcm94eVN0cnVjdHVyZWRSZXN1bHRWMjtcblxuICAgICAgZXhwZWN0KHJlc3VsdC5zdGF0dXNDb2RlKS50b0JlKDIwMCk7XG4gICAgICBjb25zdCBib2R5ID0gSlNPTi5wYXJzZShyZXN1bHQuYm9keSBhcyBzdHJpbmcpO1xuICAgICAgZXhwZWN0KGJvZHkpLnRvSGF2ZVByb3BlcnR5KCd1cGxvYWRVcmwnKTtcbiAgICAgIGV4cGVjdChib2R5KS50b0hhdmVQcm9wZXJ0eSgna2V5Jyk7XG4gICAgICBleHBlY3QoYm9keSkudG9IYXZlUHJvcGVydHkoJ2ZpbGVVcmwnKTtcbiAgICB9KTtcblxuICAgIGl0KCdQdXRPYmplY3RDb21tYW5k44GMUzPjg5DjgrHjg4Pjg4jjgajjgq3jg7zjgaflkbzjgbDjgozjgovjgZPjgagnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCB7IFB1dE9iamVjdENvbW1hbmQgfSA9IHJlcXVpcmUoJ0Bhd3Mtc2RrL2NsaWVudC1zMycpO1xuICAgICAgY29uc3QgZXZlbnQgPSBjcmVhdGVFdmVudCgpO1xuXG4gICAgICBhd2FpdCBoYW5kbGVyKGV2ZW50KTtcblxuICAgICAgZXhwZWN0KFB1dE9iamVjdENvbW1hbmQpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgICBleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XG4gICAgICAgICAgQnVja2V0OiAndGVzdC1idWNrZXQnLFxuICAgICAgICAgIEtleTogZXhwZWN0LnN0cmluZ0NvbnRhaW5pbmcoJ3VwbG9hZHMvJyksXG4gICAgICAgICAgQ29udGVudFR5cGU6ICdpbWFnZS9qcGVnJyxcbiAgICAgICAgfSlcbiAgICAgICk7XG4gICAgfSk7XG5cbiAgICBpdCgnZ2V0U2lnbmVkVXJs44GMUFVU55So44Gr5ZG844Gw44KM44KL44GT44GoJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgZXZlbnQgPSBjcmVhdGVFdmVudCgpO1xuXG4gICAgICBhd2FpdCBoYW5kbGVyKGV2ZW50KTtcblxuICAgICAgZXhwZWN0KG1vY2tHZXRTaWduZWRVcmwpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgICBleHBlY3QuYW55dGhpbmcoKSxcbiAgICAgICAgZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoe1xuICAgICAgICAgIEJ1Y2tldDogJ3Rlc3QtYnVja2V0JyxcbiAgICAgICAgICBDb250ZW50VHlwZTogJ2ltYWdlL2pwZWcnLFxuICAgICAgICB9KSxcbiAgICAgICAgeyBleHBpcmVzSW46IDM2MDAgfVxuICAgICAgKTtcbiAgICB9KTtcblxuICAgIGl0KCfjgqvjgrnjgr/jg6Djg5Xjgqnjg6vjg4DjgYzmjIflrprjgZXjgozjgZ/loLTlkIjjgIHjgZ3jga7jg5Xjgqnjg6vjg4Djgavjgq3jg7zjgYznlJ/miJDjgZXjgozjgovjgZPjgagnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCB7IFB1dE9iamVjdENvbW1hbmQgfSA9IHJlcXVpcmUoJ0Bhd3Mtc2RrL2NsaWVudC1zMycpO1xuICAgICAgY29uc3QgZXZlbnQgPSBjcmVhdGVFdmVudCh7XG4gICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgICBmaWxlTmFtZTogJ3Rlc3QuanBnJyxcbiAgICAgICAgICBjb250ZW50VHlwZTogJ2ltYWdlL2pwZWcnLFxuICAgICAgICAgIGZvbGRlcjogJ2N1c3RvbS1mb2xkZXInLFxuICAgICAgICB9KSxcbiAgICAgIH0pO1xuXG4gICAgICBhd2FpdCBoYW5kbGVyKGV2ZW50KTtcblxuICAgICAgZXhwZWN0KFB1dE9iamVjdENvbW1hbmQpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgICBleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XG4gICAgICAgICAgS2V5OiBleHBlY3Quc3RyaW5nQ29udGFpbmluZygnY3VzdG9tLWZvbGRlci8nKSxcbiAgICAgICAgfSlcbiAgICAgICk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdWYWxpZGF0aW9uJywgKCkgPT4ge1xuICAgIGl0KCfjg6rjgq/jgqjjgrnjg4jjg5zjg4fjgqPjgYzjgarjgYTloLTlkIjjgIE0MDDjgpLov5TjgZnjgZPjgagnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBldmVudCA9IGNyZWF0ZUV2ZW50KHsgYm9keTogdW5kZWZpbmVkIH0pO1xuXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBoYW5kbGVyKGV2ZW50KSBhcyBBUElHYXRld2F5UHJveHlTdHJ1Y3R1cmVkUmVzdWx0VjI7XG5cbiAgICAgIGV4cGVjdChyZXN1bHQuc3RhdHVzQ29kZSkudG9CZSg0MDApO1xuICAgICAgZXhwZWN0KEpTT04ucGFyc2UocmVzdWx0LmJvZHkgYXMgc3RyaW5nKSkudG9FcXVhbCh7XG4gICAgICAgIGVycm9yOiAnUmVxdWVzdCBib2R5IGlzIHJlcXVpcmVkJyxcbiAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgaXQoJ2ZpbGVOYW1l44GM44Gq44GE5aC05ZCI44CBNDAw44KS6L+U44GZ44GT44GoJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgZXZlbnQgPSBjcmVhdGVFdmVudCh7XG4gICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHsgY29udGVudFR5cGU6ICdpbWFnZS9qcGVnJyB9KSxcbiAgICAgIH0pO1xuXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBoYW5kbGVyKGV2ZW50KSBhcyBBUElHYXRld2F5UHJveHlTdHJ1Y3R1cmVkUmVzdWx0VjI7XG5cbiAgICAgIGV4cGVjdChyZXN1bHQuc3RhdHVzQ29kZSkudG9CZSg0MDApO1xuICAgICAgZXhwZWN0KEpTT04ucGFyc2UocmVzdWx0LmJvZHkgYXMgc3RyaW5nKSkudG9FcXVhbCh7XG4gICAgICAgIGVycm9yOiAnZmlsZU5hbWUgYW5kIGNvbnRlbnRUeXBlIGFyZSByZXF1aXJlZCcsXG4gICAgICB9KTtcbiAgICB9KTtcblxuICAgIGl0KCdjb250ZW50VHlwZeOBjOOBquOBhOWgtOWQiOOAgTQwMOOCkui/lOOBmeOBk+OBqCcsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IGV2ZW50ID0gY3JlYXRlRXZlbnQoe1xuICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7IGZpbGVOYW1lOiAndGVzdC5qcGcnIH0pLFxuICAgICAgfSk7XG5cbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGhhbmRsZXIoZXZlbnQpIGFzIEFQSUdhdGV3YXlQcm94eVN0cnVjdHVyZWRSZXN1bHRWMjtcblxuICAgICAgZXhwZWN0KHJlc3VsdC5zdGF0dXNDb2RlKS50b0JlKDQwMCk7XG4gICAgfSk7XG4gIH0pO1xufSk7XG4iXX0=