"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
// Mock AWS SDK
const mockGetSignedUrl = jest.fn().mockResolvedValue('https://s3.example.com/presigned-url');
const mockS3Client = jest.fn();
jest.mock('@aws-sdk/client-s3', () => ({
    S3Client: jest.fn().mockImplementation(() => mockS3Client),
    PutObjectCommand: jest.fn().mockImplementation((params) => params),
}));
jest.mock('@aws-sdk/s3-request-presigner', () => ({
    getSignedUrl: mockGetSignedUrl,
}));
jest.mock('crypto', () => ({
    randomUUID: jest.fn().mockReturnValue('test-uuid-1234'),
}));
// Set env before importing handler
process.env.BUCKET_NAME = 'test-bucket';
process.env.VALID_API_KEYS = ''; // Empty = accept any key (development mode)
// Import handler after mocks
const index_1 = require("../../lambda/presigned-url/index");
describe('Presigned URL Lambda', () => {
    const createEvent = (overrides = {}) => ({
        version: '2.0',
        routeKey: 'POST /presigned-url',
        rawPath: '/presigned-url',
        rawQueryString: '',
        headers: {
            'content-type': 'application/json',
            'x-api-key': 'valid-api-key',
            ...overrides.headers,
        },
        requestContext: {
            accountId: '123456789012',
            apiId: 'test-api-id',
            domainName: 'test.execute-api.ap-northeast-1.amazonaws.com',
            domainPrefix: 'test',
            http: {
                method: 'POST',
                path: '/presigned-url',
                protocol: 'HTTP/1.1',
                sourceIp: '127.0.0.1',
                userAgent: 'test-agent',
            },
            requestId: 'test-request-id',
            routeKey: 'POST /presigned-url',
            stage: '$default',
            time: '01/Jan/2024:00:00:00 +0000',
            timeEpoch: 1704067200000,
        },
        body: JSON.stringify({
            fileName: 'test.jpg',
            contentType: 'image/jpeg',
            projectCode: 'berry',
            ownerKey: 'user-123',
        }),
        isBase64Encoded: false,
        ...overrides,
    });
    beforeEach(() => {
        jest.clearAllMocks();
    });
    describe('AC1: API Key Validation - 403 Forbidden', () => {
        it('API Keyがない場合、403 Forbiddenを返すこと', async () => {
            const event = createEvent({
                headers: {
                    'content-type': 'application/json',
                    // x-api-key is missing
                },
            });
            const result = await (0, index_1.handler)(event);
            expect(result.statusCode).toBe(403);
            expect(JSON.parse(result.body)).toEqual({
                error: 'Forbidden: API Key required',
            });
        });
        it('API Keyが空文字の場合、403 Forbiddenを返すこと', async () => {
            const event = createEvent({
                headers: {
                    'content-type': 'application/json',
                    'x-api-key': '',
                },
            });
            const result = await (0, index_1.handler)(event);
            expect(result.statusCode).toBe(403);
        });
        it('有効なAPI Keyがある場合、403を返さないこと', async () => {
            const event = createEvent();
            const result = await (0, index_1.handler)(event);
            expect(result.statusCode).not.toBe(403);
        });
    });
    describe('AC2: Presigned URL Generation with putObject permission', () => {
        it('正常なリクエストで署名付きURLを発行すること', async () => {
            const event = createEvent();
            const result = await (0, index_1.handler)(event);
            expect(result.statusCode).toBe(200);
            const body = JSON.parse(result.body);
            expect(body).toHaveProperty('uploadUrl');
            expect(body).toHaveProperty('key');
            expect(body).toHaveProperty('fileUrl');
        });
        it('PutObjectCommandがS3バケットとキーで呼ばれること', async () => {
            const { PutObjectCommand } = require('@aws-sdk/client-s3');
            const event = createEvent();
            await (0, index_1.handler)(event);
            expect(PutObjectCommand).toHaveBeenCalledWith(expect.objectContaining({
                Bucket: 'test-bucket',
                Key: 'berry/user-123/uploads/test-uuid-1234.jpg',
                ContentType: 'image/jpeg',
            }));
        });
        it('getSignedUrlがPUT用に呼ばれること', async () => {
            const event = createEvent();
            await (0, index_1.handler)(event);
            expect(mockGetSignedUrl).toHaveBeenCalledWith(expect.anything(), expect.objectContaining({
                Bucket: 'test-bucket',
                ContentType: 'image/jpeg',
            }), { expiresIn: 3600 });
        });
        it('カスタムフォルダが指定された場合、そのフォルダにキーが生成されること', async () => {
            const { PutObjectCommand } = require('@aws-sdk/client-s3');
            const event = createEvent({
                body: JSON.stringify({
                    fileName: 'test.jpg',
                    contentType: 'image/jpeg',
                    projectCode: 'berry',
                    ownerKey: 'user-123',
                    folder: 'custom-folder',
                }),
            });
            await (0, index_1.handler)(event);
            expect(PutObjectCommand).toHaveBeenCalledWith(expect.objectContaining({
                Key: 'berry/user-123/custom-folder/test-uuid-1234.jpg',
            }));
        });
    });
    describe('Validation', () => {
        it('リクエストボディがない場合、400を返すこと', async () => {
            const event = createEvent({ body: undefined });
            const result = await (0, index_1.handler)(event);
            expect(result.statusCode).toBe(400);
            expect(JSON.parse(result.body)).toEqual({
                error: 'Request body is required',
            });
        });
        it('fileNameがない場合、400を返すこと', async () => {
            const event = createEvent({
                body: JSON.stringify({ contentType: 'image/jpeg' }),
            });
            const result = await (0, index_1.handler)(event);
            expect(result.statusCode).toBe(400);
            expect(JSON.parse(result.body)).toEqual({
                error: 'fileName and contentType are required',
            });
        });
        it('contentTypeがない場合、400を返すこと', async () => {
            const event = createEvent({
                body: JSON.stringify({ fileName: 'test.jpg', projectCode: 'berry', ownerKey: 'user-123' }),
            });
            const result = await (0, index_1.handler)(event);
            expect(result.statusCode).toBe(400);
        });
        it('projectCodeがない場合、400を返すこと', async () => {
            const event = createEvent({
                body: JSON.stringify({
                    fileName: 'test.jpg',
                    contentType: 'image/jpeg',
                    ownerKey: 'user-123',
                }),
            });
            const result = await (0, index_1.handler)(event);
            expect(result.statusCode).toBe(400);
            expect(JSON.parse(result.body)).toEqual({
                error: 'projectCode and ownerKey are required',
            });
        });
        it('ownerKeyがない場合、400を返すこと', async () => {
            const event = createEvent({
                body: JSON.stringify({
                    fileName: 'test.jpg',
                    contentType: 'image/jpeg',
                    projectCode: 'berry',
                }),
            });
            const result = await (0, index_1.handler)(event);
            expect(result.statusCode).toBe(400);
            expect(JSON.parse(result.body)).toEqual({
                error: 'projectCode and ownerKey are required',
            });
        });
    });
    describe('v2: Key structure with projectCode/ownerKey', () => {
        it('キーが {projectCode}/{ownerKey}/{folder}/{UUID}.{ext} 形式で生成されること', async () => {
            const event = createEvent();
            const result = await (0, index_1.handler)(event);
            expect(result.statusCode).toBe(200);
            const body = JSON.parse(result.body);
            expect(body.key).toBe('berry/user-123/uploads/test-uuid-1234.jpg');
        });
        it('folder未指定時はデフォルト uploads が使われること', async () => {
            const event = createEvent({
                body: JSON.stringify({
                    fileName: 'test.jpg',
                    contentType: 'image/jpeg',
                    projectCode: 'sakura',
                    ownerKey: 'team-abc',
                }),
            });
            const result = await (0, index_1.handler)(event);
            const body = JSON.parse(result.body);
            expect(body.key).toBe('sakura/team-abc/uploads/test-uuid-1234.jpg');
        });
    });
    describe('v2: S3 Object Tagging', () => {
        it('tags未指定でもアップロードが成功すること', async () => {
            const event = createEvent();
            const result = await (0, index_1.handler)(event);
            expect(result.statusCode).toBe(200);
        });
        it('tags指定時にPutObjectCommandのTaggingパラメータにタグが含まれること', async () => {
            const { PutObjectCommand } = require('@aws-sdk/client-s3');
            const event = createEvent({
                body: JSON.stringify({
                    fileName: 'test.jpg',
                    contentType: 'image/jpeg',
                    projectCode: 'berry',
                    ownerKey: 'user-123',
                    tags: { category: 'avatar', status: 'active' },
                }),
            });
            await (0, index_1.handler)(event);
            expect(PutObjectCommand).toHaveBeenCalledWith(expect.objectContaining({
                Tagging: 'category=avatar&status=active',
            }));
        });
        it('複数タグが正しくエンコードされること', async () => {
            const { PutObjectCommand } = require('@aws-sdk/client-s3');
            const event = createEvent({
                body: JSON.stringify({
                    fileName: 'test.jpg',
                    contentType: 'image/jpeg',
                    projectCode: 'berry',
                    ownerKey: 'user-123',
                    tags: { a: '1', b: '2', c: '3' },
                }),
            });
            await (0, index_1.handler)(event);
            const call = PutObjectCommand.mock.calls[0][0];
            expect(call.Tagging).toContain('a=1');
            expect(call.Tagging).toContain('b=2');
            expect(call.Tagging).toContain('c=3');
        });
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJlc2lnbmVkLXVybC50ZXN0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vdGVzdC9sYW1iZGEvcHJlc2lnbmVkLXVybC50ZXN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBTUEsZUFBZTtBQUNmLE1BQU0sZ0JBQWdCLEdBQUcsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLGlCQUFpQixDQUFDLHNDQUFzQyxDQUFDLENBQUM7QUFDN0YsTUFBTSxZQUFZLEdBQUcsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDO0FBRS9CLElBQUksQ0FBQyxJQUFJLENBQUMsb0JBQW9CLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQztJQUNyQyxRQUFRLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLGtCQUFrQixDQUFDLEdBQUcsRUFBRSxDQUFDLFlBQVksQ0FBQztJQUMxRCxnQkFBZ0IsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsa0JBQWtCLENBQUMsQ0FBQyxNQUFNLEVBQUUsRUFBRSxDQUFDLE1BQU0sQ0FBQztDQUNuRSxDQUFDLENBQUMsQ0FBQztBQUVKLElBQUksQ0FBQyxJQUFJLENBQUMsK0JBQStCLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQztJQUNoRCxZQUFZLEVBQUUsZ0JBQWdCO0NBQy9CLENBQUMsQ0FBQyxDQUFDO0FBRUosSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQztJQUN6QixVQUFVLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLGVBQWUsQ0FBQyxnQkFBZ0IsQ0FBQztDQUN4RCxDQUFDLENBQUMsQ0FBQztBQUVKLG1DQUFtQztBQUNuQyxPQUFPLENBQUMsR0FBRyxDQUFDLFdBQVcsR0FBRyxhQUFhLENBQUM7QUFDeEMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxjQUFjLEdBQUcsRUFBRSxDQUFDLENBQUMsNENBQTRDO0FBRTdFLDZCQUE2QjtBQUM3Qiw0REFB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gapBUEkgS2V544GM44Gq44GE44Oq44Kv44Ko44K544OI44GvNDAzIEZvcmJpZGRlbuOCkui/lOOBmeOBk+OBqFxuICogQUMyOiBMYW1iZGEgcHV0T2JqZWN05qip6ZmQ44OG44K544OIIC0gUzPjga5wdXRPYmplY3TmqKnpmZDjgpLmjIHjgaTnvbLlkI3ku5jjgY1VUkzjgpLmraPluLjjgavnmbrooYzjgZnjgovjgZPjgahcbiAqL1xuaW1wb3J0IHsgQVBJR2F0ZXdheVByb3h5RXZlbnRWMiwgQVBJR2F0ZXdheVByb3h5U3RydWN0dXJlZFJlc3VsdFYyIH0gZnJvbSAnYXdzLWxhbWJkYSc7XG5cbi8vIE1vY2sgQVdTIFNES1xuY29uc3QgbW9ja0dldFNpZ25lZFVybCA9IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZSgnaHR0cHM6Ly9zMy5leGFtcGxlLmNvbS9wcmVzaWduZWQtdXJsJyk7XG5jb25zdCBtb2NrUzNDbGllbnQgPSBqZXN0LmZuKCk7XG5cbmplc3QubW9jaygnQGF3cy1zZGsvY2xpZW50LXMzJywgKCkgPT4gKHtcbiAgUzNDbGllbnQ6IGplc3QuZm4oKS5tb2NrSW1wbGVtZW50YXRpb24oKCkgPT4gbW9ja1MzQ2xpZW50KSxcbiAgUHV0T2JqZWN0Q29tbWFuZDogamVzdC5mbigpLm1vY2tJbXBsZW1lbnRhdGlvbigocGFyYW1zKSA9PiBwYXJhbXMpLFxufSkpO1xuXG5qZXN0Lm1vY2soJ0Bhd3Mtc2RrL3MzLXJlcXVlc3QtcHJlc2lnbmVyJywgKCkgPT4gKHtcbiAgZ2V0U2lnbmVkVXJsOiBtb2NrR2V0U2lnbmVkVXJsLFxufSkpO1xuXG5qZXN0Lm1vY2soJ2NyeXB0bycsICgpID0+ICh7XG4gIHJhbmRvbVVVSUQ6IGplc3QuZm4oKS5tb2NrUmV0dXJuVmFsdWUoJ3Rlc3QtdXVpZC0xMjM0JyksXG59KSk7XG5cbi8vIFNldCBlbnYgYmVmb3JlIGltcG9ydGluZyBoYW5kbGVyXG5wcm9jZXNzLmVudi5CVUNLRVRfTkFNRSA9ICd0ZXN0LWJ1Y2tldCc7XG5wcm9jZXNzLmVudi5WQUxJRF9BUElfS0VZUyA9ICcnOyAvLyBFbXB0eSA9IGFjY2VwdCBhbnkga2V5IChkZXZlbG9wbWVudCBtb2RlKVxuXG4vLyBJbXBvcnQgaGFuZGxlciBhZnRlciBtb2Nrc1xuaW1wb3J0IHsgaGFuZGxlciB9IGZyb20gJy4uLy4uL2xhbWJkYS9wcmVzaWduZWQtdXJsL2luZGV4JztcblxuZGVzY3JpYmUoJ1ByZXNpZ25lZCBVUkwgTGFtYmRhJywgKCkgPT4ge1xuICBjb25zdCBjcmVhdGVFdmVudCA9IChvdmVycmlkZXM6IFBhcnRpYWw8QVBJR2F0ZXdheVByb3h5RXZlbnRWMj4gPSB7fSk6IEFQSUdhdGV3YXlQcm94eUV2ZW50VjIgPT4gKHtcbiAgICB2ZXJzaW9uOiAnMi4wJyxcbiAgICByb3V0ZUtleTogJ1BPU1QgL3ByZXNpZ25lZC11cmwnLFxuICAgIHJhd1BhdGg6ICcvcHJlc2lnbmVkLXVybCcsXG4gICAgcmF3UXVlcnlTdHJpbmc6ICcnLFxuICAgIGhlYWRlcnM6IHtcbiAgICAgICdjb250ZW50LXR5cGUnOiAnYXBwbGljYXRpb24vanNvbicsXG4gICAgICAneC1hcGkta2V5JzogJ3ZhbGlkLWFwaS1rZXknLFxuICAgICAgLi4ub3ZlcnJpZGVzLmhlYWRlcnMsXG4gICAgfSxcbiAgICByZXF1ZXN0Q29udGV4dDoge1xuICAgICAgYWNjb3VudElkOiAnMTIzNDU2Nzg5MDEyJyxcbiAgICAgIGFwaUlkOiAndGVzdC1hcGktaWQnLFxuICAgICAgZG9tYWluTmFtZTogJ3Rlc3QuZXhlY3V0ZS1hcGkuYXAtbm9ydGhlYXN0LTEuYW1hem9uYXdzLmNvbScsXG4gICAgICBkb21haW5QcmVmaXg6ICd0ZXN0JyxcbiAgICAgIGh0dHA6IHtcbiAgICAgICAgbWV0aG9kOiAnUE9TVCcsXG4gICAgICAgIHBhdGg6ICcvcHJlc2lnbmVkLXVybCcsXG4gICAgICAgIHByb3RvY29sOiAnSFRUUC8xLjEnLFxuICAgICAgICBzb3VyY2VJcDogJzEyNy4wLjAuMScsXG4gICAgICAgIHVzZXJBZ2VudDogJ3Rlc3QtYWdlbnQnLFxuICAgICAgfSxcbiAgICAgIHJlcXVlc3RJZDogJ3Rlc3QtcmVxdWVzdC1pZCcsXG4gICAgICByb3V0ZUtleTogJ1BPU1QgL3ByZXNpZ25lZC11cmwnLFxuICAgICAgc3RhZ2U6ICckZGVmYXVsdCcsXG4gICAgICB0aW1lOiAnMDEvSmFuLzIwMjQ6MDA6MDA6MDAgKzAwMDAnLFxuICAgICAgdGltZUVwb2NoOiAxNzA0MDY3MjAwMDAwLFxuICAgIH0sXG4gICAgYm9keTogSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgZmlsZU5hbWU6ICd0ZXN0LmpwZycsXG4gICAgICBjb250ZW50VHlwZTogJ2ltYWdlL2pwZWcnLFxuICAgICAgcHJvamVjdENvZGU6ICdiZXJyeScsXG4gICAgICBvd25lcktleTogJ3VzZXItMTIzJyxcbiAgICB9KSxcbiAgICBpc0Jhc2U2NEVuY29kZWQ6IGZhbHNlLFxuICAgIC4uLm92ZXJyaWRlcyxcbiAgfSk7XG5cbiAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgamVzdC5jbGVhckFsbE1vY2tzKCk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdBQzE6IEFQSSBLZXkgVmFsaWRhdGlvbiAtIDQwMyBGb3JiaWRkZW4nLCAoKSA9PiB7XG4gICAgaXQoJ0FQSSBLZXnjgYzjgarjgYTloLTlkIjjgIE0MDMgRm9yYmlkZGVu44KS6L+U44GZ44GT44GoJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgZXZlbnQgPSBjcmVhdGVFdmVudCh7XG4gICAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgICAnY29udGVudC10eXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nLFxuICAgICAgICAgIC8vIHgtYXBpLWtleSBpcyBtaXNzaW5nXG4gICAgICAgIH0sXG4gICAgICB9KTtcblxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgaGFuZGxlcihldmVudCkgYXMgQVBJR2F0ZXdheVByb3h5U3RydWN0dXJlZFJlc3VsdFYyO1xuXG4gICAgICBleHBlY3QocmVzdWx0LnN0YXR1c0NvZGUpLnRvQmUoNDAzKTtcbiAgICAgIGV4cGVjdChKU09OLnBhcnNlKHJlc3VsdC5ib2R5IGFzIHN0cmluZykpLnRvRXF1YWwoe1xuICAgICAgICBlcnJvcjogJ0ZvcmJpZGRlbjogQVBJIEtleSByZXF1aXJlZCcsXG4gICAgICB9KTtcbiAgICB9KTtcblxuICAgIGl0KCdBUEkgS2V544GM56m65paH5a2X44Gu5aC05ZCI44CBNDAzIEZvcmJpZGRlbuOCkui/lOOBmeOBk+OBqCcsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IGV2ZW50ID0gY3JlYXRlRXZlbnQoe1xuICAgICAgICBoZWFkZXJzOiB7XG4gICAgICAgICAgJ2NvbnRlbnQtdHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJyxcbiAgICAgICAgICAneC1hcGkta2V5JzogJycsXG4gICAgICAgIH0sXG4gICAgICB9KTtcblxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgaGFuZGxlcihldmVudCkgYXMgQVBJR2F0ZXdheVByb3h5U3RydWN0dXJlZFJlc3VsdFYyO1xuXG4gICAgICBleHBlY3QocmVzdWx0LnN0YXR1c0NvZGUpLnRvQmUoNDAzKTtcbiAgICB9KTtcblxuICAgIGl0KCfmnInlirnjgapBUEkgS2V544GM44GC44KL5aC05ZCI44CBNDAz44KS6L+U44GV44Gq44GE44GT44GoJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgZXZlbnQgPSBjcmVhdGVFdmVudCgpO1xuXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBoYW5kbGVyKGV2ZW50KSBhcyBBUElHYXRld2F5UHJveHlTdHJ1Y3R1cmVkUmVzdWx0VjI7XG5cbiAgICAgIGV4cGVjdChyZXN1bHQuc3RhdHVzQ29kZSkubm90LnRvQmUoNDAzKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ0FDMjogUHJlc2lnbmVkIFVSTCBHZW5lcmF0aW9uIHdpdGggcHV0T2JqZWN0IHBlcm1pc3Npb24nLCAoKSA9PiB7XG4gICAgaXQoJ+ato+W4uOOBquODquOCr+OCqOOCueODiOOBp+e9suWQjeS7mOOBjVVSTOOCkueZuuihjOOBmeOCi+OBk+OBqCcsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IGV2ZW50ID0gY3JlYXRlRXZlbnQoKTtcblxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgaGFuZGxlcihldmVudCkgYXMgQVBJR2F0ZXdheVByb3h5U3RydWN0dXJlZFJlc3VsdFYyO1xuXG4gICAgICBleHBlY3QocmVzdWx0LnN0YXR1c0NvZGUpLnRvQmUoMjAwKTtcbiAgICAgIGNvbnN0IGJvZHkgPSBKU09OLnBhcnNlKHJlc3VsdC5ib2R5IGFzIHN0cmluZyk7XG4gICAgICBleHBlY3QoYm9keSkudG9IYXZlUHJvcGVydHkoJ3VwbG9hZFVybCcpO1xuICAgICAgZXhwZWN0KGJvZHkpLnRvSGF2ZVByb3BlcnR5KCdrZXknKTtcbiAgICAgIGV4cGVjdChib2R5KS50b0hhdmVQcm9wZXJ0eSgnZmlsZVVybCcpO1xuICAgIH0pO1xuXG4gICAgaXQoJ1B1dE9iamVjdENvbW1hbmTjgYxTM+ODkOOCseODg+ODiOOBqOOCreODvOOBp+WRvOOBsOOCjOOCi+OBk+OBqCcsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IHsgUHV0T2JqZWN0Q29tbWFuZCB9ID0gcmVxdWlyZSgnQGF3cy1zZGsvY2xpZW50LXMzJyk7XG4gICAgICBjb25zdCBldmVudCA9IGNyZWF0ZUV2ZW50KCk7XG5cbiAgICAgIGF3YWl0IGhhbmRsZXIoZXZlbnQpO1xuXG4gICAgICBleHBlY3QoUHV0T2JqZWN0Q29tbWFuZCkudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICAgIGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcbiAgICAgICAgICBCdWNrZXQ6ICd0ZXN0LWJ1Y2tldCcsXG4gICAgICAgICAgS2V5OiAnYmVycnkvdXNlci0xMjMvdXBsb2Fkcy90ZXN0LXV1aWQtMTIzNC5qcGcnLFxuICAgICAgICAgIENvbnRlbnRUeXBlOiAnaW1hZ2UvanBlZycsXG4gICAgICAgIH0pXG4gICAgICApO1xuICAgIH0pO1xuXG4gICAgaXQoJ2dldFNpZ25lZFVybOOBjFBVVOeUqOOBq+WRvOOBsOOCjOOCi+OBk+OBqCcsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IGV2ZW50ID0gY3JlYXRlRXZlbnQoKTtcblxuICAgICAgYXdhaXQgaGFuZGxlcihldmVudCk7XG5cbiAgICAgIGV4cGVjdChtb2NrR2V0U2lnbmVkVXJsKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgICAgZXhwZWN0LmFueXRoaW5nKCksXG4gICAgICAgIGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcbiAgICAgICAgICBCdWNrZXQ6ICd0ZXN0LWJ1Y2tldCcsXG4gICAgICAgICAgQ29udGVudFR5cGU6ICdpbWFnZS9qcGVnJyxcbiAgICAgICAgfSksXG4gICAgICAgIHsgZXhwaXJlc0luOiAzNjAwIH1cbiAgICAgICk7XG4gICAgfSk7XG5cbiAgICBpdCgn44Kr44K544K/44Og44OV44Kp44Or44OA44GM5oyH5a6a44GV44KM44Gf5aC05ZCI44CB44Gd44Gu44OV44Kp44Or44OA44Gr44Kt44O844GM55Sf5oiQ44GV44KM44KL44GT44GoJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgeyBQdXRPYmplY3RDb21tYW5kIH0gPSByZXF1aXJlKCdAYXdzLXNkay9jbGllbnQtczMnKTtcbiAgICAgIGNvbnN0IGV2ZW50ID0gY3JlYXRlRXZlbnQoe1xuICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgICAgZmlsZU5hbWU6ICd0ZXN0LmpwZycsXG4gICAgICAgICAgY29udGVudFR5cGU6ICdpbWFnZS9qcGVnJyxcbiAgICAgICAgICBwcm9qZWN0Q29kZTogJ2JlcnJ5JyxcbiAgICAgICAgICBvd25lcktleTogJ3VzZXItMTIzJyxcbiAgICAgICAgICBmb2xkZXI6ICdjdXN0b20tZm9sZGVyJyxcbiAgICAgICAgfSksXG4gICAgICB9KTtcblxuICAgICAgYXdhaXQgaGFuZGxlcihldmVudCk7XG5cbiAgICAgIGV4cGVjdChQdXRPYmplY3RDb21tYW5kKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgICAgZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoe1xuICAgICAgICAgIEtleTogJ2JlcnJ5L3VzZXItMTIzL2N1c3RvbS1mb2xkZXIvdGVzdC11dWlkLTEyMzQuanBnJyxcbiAgICAgICAgfSlcbiAgICAgICk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdWYWxpZGF0aW9uJywgKCkgPT4ge1xuICAgIGl0KCfjg6rjgq/jgqjjgrnjg4jjg5zjg4fjgqPjgYzjgarjgYTloLTlkIjjgIE0MDDjgpLov5TjgZnjgZPjgagnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBldmVudCA9IGNyZWF0ZUV2ZW50KHsgYm9keTogdW5kZWZpbmVkIH0pO1xuXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBoYW5kbGVyKGV2ZW50KSBhcyBBUElHYXRld2F5UHJveHlTdHJ1Y3R1cmVkUmVzdWx0VjI7XG5cbiAgICAgIGV4cGVjdChyZXN1bHQuc3RhdHVzQ29kZSkudG9CZSg0MDApO1xuICAgICAgZXhwZWN0KEpTT04ucGFyc2UocmVzdWx0LmJvZHkgYXMgc3RyaW5nKSkudG9FcXVhbCh7XG4gICAgICAgIGVycm9yOiAnUmVxdWVzdCBib2R5IGlzIHJlcXVpcmVkJyxcbiAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgaXQoJ2ZpbGVOYW1l44GM44Gq44GE5aC05ZCI44CBNDAw44KS6L+U44GZ44GT44GoJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgZXZlbnQgPSBjcmVhdGVFdmVudCh7XG4gICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHsgY29udGVudFR5cGU6ICdpbWFnZS9qcGVnJyB9KSxcbiAgICAgIH0pO1xuXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBoYW5kbGVyKGV2ZW50KSBhcyBBUElHYXRld2F5UHJveHlTdHJ1Y3R1cmVkUmVzdWx0VjI7XG5cbiAgICAgIGV4cGVjdChyZXN1bHQuc3RhdHVzQ29kZSkudG9CZSg0MDApO1xuICAgICAgZXhwZWN0KEpTT04ucGFyc2UocmVzdWx0LmJvZHkgYXMgc3RyaW5nKSkudG9FcXVhbCh7XG4gICAgICAgIGVycm9yOiAnZmlsZU5hbWUgYW5kIGNvbnRlbnRUeXBlIGFyZSByZXF1aXJlZCcsXG4gICAgICB9KTtcbiAgICB9KTtcblxuICAgIGl0KCdjb250ZW50VHlwZeOBjOOBquOBhOWgtOWQiOOAgTQwMOOCkui/lOOBmeOBk+OBqCcsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IGV2ZW50ID0gY3JlYXRlRXZlbnQoe1xuICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7IGZpbGVOYW1lOiAndGVzdC5qcGcnLCBwcm9qZWN0Q29kZTogJ2JlcnJ5Jywgb3duZXJLZXk6ICd1c2VyLTEyMycgfSksXG4gICAgICB9KTtcblxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgaGFuZGxlcihldmVudCkgYXMgQVBJR2F0ZXdheVByb3h5U3RydWN0dXJlZFJlc3VsdFYyO1xuXG4gICAgICBleHBlY3QocmVzdWx0LnN0YXR1c0NvZGUpLnRvQmUoNDAwKTtcbiAgICB9KTtcblxuICAgIGl0KCdwcm9qZWN0Q29kZeOBjOOBquOBhOWgtOWQiOOAgTQwMOOCkui/lOOBmeOBk+OBqCcsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IGV2ZW50ID0gY3JlYXRlRXZlbnQoe1xuICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgICAgZmlsZU5hbWU6ICd0ZXN0LmpwZycsXG4gICAgICAgICAgY29udGVudFR5cGU6ICdpbWFnZS9qcGVnJyxcbiAgICAgICAgICBvd25lcktleTogJ3VzZXItMTIzJyxcbiAgICAgICAgfSksXG4gICAgICB9KTtcblxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgaGFuZGxlcihldmVudCkgYXMgQVBJR2F0ZXdheVByb3h5U3RydWN0dXJlZFJlc3VsdFYyO1xuXG4gICAgICBleHBlY3QocmVzdWx0LnN0YXR1c0NvZGUpLnRvQmUoNDAwKTtcbiAgICAgIGV4cGVjdChKU09OLnBhcnNlKHJlc3VsdC5ib2R5IGFzIHN0cmluZykpLnRvRXF1YWwoe1xuICAgICAgICBlcnJvcjogJ3Byb2plY3RDb2RlIGFuZCBvd25lcktleSBhcmUgcmVxdWlyZWQnLFxuICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBpdCgnb3duZXJLZXnjgYzjgarjgYTloLTlkIjjgIE0MDDjgpLov5TjgZnjgZPjgagnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBldmVudCA9IGNyZWF0ZUV2ZW50KHtcbiAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgICAgIGZpbGVOYW1lOiAndGVzdC5qcGcnLFxuICAgICAgICAgIGNvbnRlbnRUeXBlOiAnaW1hZ2UvanBlZycsXG4gICAgICAgICAgcHJvamVjdENvZGU6ICdiZXJyeScsXG4gICAgICAgIH0pLFxuICAgICAgfSk7XG5cbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGhhbmRsZXIoZXZlbnQpIGFzIEFQSUdhdGV3YXlQcm94eVN0cnVjdHVyZWRSZXN1bHRWMjtcblxuICAgICAgZXhwZWN0KHJlc3VsdC5zdGF0dXNDb2RlKS50b0JlKDQwMCk7XG4gICAgICBleHBlY3QoSlNPTi5wYXJzZShyZXN1bHQuYm9keSBhcyBzdHJpbmcpKS50b0VxdWFsKHtcbiAgICAgICAgZXJyb3I6ICdwcm9qZWN0Q29kZSBhbmQgb3duZXJLZXkgYXJlIHJlcXVpcmVkJyxcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgndjI6IEtleSBzdHJ1Y3R1cmUgd2l0aCBwcm9qZWN0Q29kZS9vd25lcktleScsICgpID0+IHtcbiAgICBpdCgn44Kt44O844GMIHtwcm9qZWN0Q29kZX0ve293bmVyS2V5fS97Zm9sZGVyfS97VVVJRH0ue2V4dH0g5b2i5byP44Gn55Sf5oiQ44GV44KM44KL44GT44GoJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgZXZlbnQgPSBjcmVhdGVFdmVudCgpO1xuXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBoYW5kbGVyKGV2ZW50KSBhcyBBUElHYXRld2F5UHJveHlTdHJ1Y3R1cmVkUmVzdWx0VjI7XG5cbiAgICAgIGV4cGVjdChyZXN1bHQuc3RhdHVzQ29kZSkudG9CZSgyMDApO1xuICAgICAgY29uc3QgYm9keSA9IEpTT04ucGFyc2UocmVzdWx0LmJvZHkgYXMgc3RyaW5nKTtcbiAgICAgIGV4cGVjdChib2R5LmtleSkudG9CZSgnYmVycnkvdXNlci0xMjMvdXBsb2Fkcy90ZXN0LXV1aWQtMTIzNC5qcGcnKTtcbiAgICB9KTtcblxuICAgIGl0KCdmb2xkZXLmnKrmjIflrprmmYLjga/jg4fjg5Xjgqnjg6vjg4ggdXBsb2FkcyDjgYzkvb/jgo/jgozjgovjgZPjgagnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBldmVudCA9IGNyZWF0ZUV2ZW50KHtcbiAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgICAgIGZpbGVOYW1lOiAndGVzdC5qcGcnLFxuICAgICAgICAgIGNvbnRlbnRUeXBlOiAnaW1hZ2UvanBlZycsXG4gICAgICAgICAgcHJvamVjdENvZGU6ICdzYWt1cmEnLFxuICAgICAgICAgIG93bmVyS2V5OiAndGVhbS1hYmMnLFxuICAgICAgICB9KSxcbiAgICAgIH0pO1xuXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBoYW5kbGVyKGV2ZW50KSBhcyBBUElHYXRld2F5UHJveHlTdHJ1Y3R1cmVkUmVzdWx0VjI7XG5cbiAgICAgIGNvbnN0IGJvZHkgPSBKU09OLnBhcnNlKHJlc3VsdC5ib2R5IGFzIHN0cmluZyk7XG4gICAgICBleHBlY3QoYm9keS5rZXkpLnRvQmUoJ3Nha3VyYS90ZWFtLWFiYy91cGxvYWRzL3Rlc3QtdXVpZC0xMjM0LmpwZycpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgndjI6IFMzIE9iamVjdCBUYWdnaW5nJywgKCkgPT4ge1xuICAgIGl0KCd0YWdz5pyq5oyH5a6a44Gn44KC44Ki44OD44OX44Ot44O844OJ44GM5oiQ5Yqf44GZ44KL44GT44GoJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgZXZlbnQgPSBjcmVhdGVFdmVudCgpO1xuXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBoYW5kbGVyKGV2ZW50KSBhcyBBUElHYXRld2F5UHJveHlTdHJ1Y3R1cmVkUmVzdWx0VjI7XG5cbiAgICAgIGV4cGVjdChyZXN1bHQuc3RhdHVzQ29kZSkudG9CZSgyMDApO1xuICAgIH0pO1xuXG4gICAgaXQoJ3RhZ3PmjIflrprmmYLjgatQdXRPYmplY3RDb21tYW5k44GuVGFnZ2luZ+ODkeODqeODoeODvOOCv+OBq+OCv+OCsOOBjOWQq+OBvuOCjOOCi+OBk+OBqCcsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IHsgUHV0T2JqZWN0Q29tbWFuZCB9ID0gcmVxdWlyZSgnQGF3cy1zZGsvY2xpZW50LXMzJyk7XG4gICAgICBjb25zdCBldmVudCA9IGNyZWF0ZUV2ZW50KHtcbiAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgICAgIGZpbGVOYW1lOiAndGVzdC5qcGcnLFxuICAgICAgICAgIGNvbnRlbnRUeXBlOiAnaW1hZ2UvanBlZycsXG4gICAgICAgICAgcHJvamVjdENvZGU6ICdiZXJyeScsXG4gICAgICAgICAgb3duZXJLZXk6ICd1c2VyLTEyMycsXG4gICAgICAgICAgdGFnczogeyBjYXRlZ29yeTogJ2F2YXRhcicsIHN0YXR1czogJ2FjdGl2ZScgfSxcbiAgICAgICAgfSksXG4gICAgICB9KTtcblxuICAgICAgYXdhaXQgaGFuZGxlcihldmVudCk7XG5cbiAgICAgIGV4cGVjdChQdXRPYmplY3RDb21tYW5kKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgICAgZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoe1xuICAgICAgICAgIFRhZ2dpbmc6ICdjYXRlZ29yeT1hdmF0YXImc3RhdHVzPWFjdGl2ZScsXG4gICAgICAgIH0pXG4gICAgICApO1xuICAgIH0pO1xuXG4gICAgaXQoJ+ikh+aVsOOCv+OCsOOBjOato+OBl+OBj+OCqOODs+OCs+ODvOODieOBleOCjOOCi+OBk+OBqCcsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IHsgUHV0T2JqZWN0Q29tbWFuZCB9ID0gcmVxdWlyZSgnQGF3cy1zZGsvY2xpZW50LXMzJyk7XG4gICAgICBjb25zdCBldmVudCA9IGNyZWF0ZUV2ZW50KHtcbiAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgICAgIGZpbGVOYW1lOiAndGVzdC5qcGcnLFxuICAgICAgICAgIGNvbnRlbnRUeXBlOiAnaW1hZ2UvanBlZycsXG4gICAgICAgICAgcHJvamVjdENvZGU6ICdiZXJyeScsXG4gICAgICAgICAgb3duZXJLZXk6ICd1c2VyLTEyMycsXG4gICAgICAgICAgdGFnczogeyBhOiAnMScsIGI6ICcyJywgYzogJzMnIH0sXG4gICAgICAgIH0pLFxuICAgICAgfSk7XG5cbiAgICAgIGF3YWl0IGhhbmRsZXIoZXZlbnQpO1xuXG4gICAgICBjb25zdCBjYWxsID0gUHV0T2JqZWN0Q29tbWFuZC5tb2NrLmNhbGxzWzBdWzBdO1xuICAgICAgZXhwZWN0KGNhbGwuVGFnZ2luZykudG9Db250YWluKCdhPTEnKTtcbiAgICAgIGV4cGVjdChjYWxsLlRhZ2dpbmcpLnRvQ29udGFpbignYj0yJyk7XG4gICAgICBleHBlY3QoY2FsbC5UYWdnaW5nKS50b0NvbnRhaW4oJ2M9MycpO1xuICAgIH0pO1xuICB9KTtcbn0pO1xuIl19