"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
// Mock AWS SDK
const mockSend = jest.fn().mockResolvedValue({});
jest.mock('@aws-sdk/client-s3', () => ({
    S3Client: jest.fn().mockImplementation(() => ({ send: mockSend })),
    DeleteObjectCommand: jest.fn().mockImplementation((params) => params),
}));
// Set env before importing handler
process.env.BUCKET_NAME = 'test-bucket';
process.env.VALID_API_KEYS = '';
// Import handler after mocks
const index_1 = require("../../lambda/delete-object/index");
describe('Delete Object Lambda', () => {
    const createEvent = (overrides = {}) => ({
        version: '2.0',
        routeKey: 'DELETE /objects',
        rawPath: '/objects',
        rawQueryString: '',
        headers: {
            'content-type': 'application/json',
            'x-api-key': 'valid-api-key',
            ...overrides.headers,
        },
        requestContext: {
            accountId: '123456789012',
            apiId: 'test-api-id',
            domainName: 'test.execute-api.ap-northeast-1.amazonaws.com',
            domainPrefix: 'test',
            http: {
                method: 'DELETE',
                path: '/objects',
                protocol: 'HTTP/1.1',
                sourceIp: '127.0.0.1',
                userAgent: 'test-agent',
            },
            requestId: 'test-request-id',
            routeKey: 'DELETE /objects',
            stage: '$default',
            time: '01/Jan/2024:00:00:00 +0000',
            timeEpoch: 1704067200000,
        },
        body: JSON.stringify({
            key: 'berry/user-123/uploads/test-uuid.jpg',
        }),
        isBase64Encoded: false,
        ...overrides,
    });
    beforeEach(() => {
        jest.clearAllMocks();
    });
    describe('API Key Validation', () => {
        it('API Keyがない場合、403を返すこと', async () => {
            const event = createEvent({
                headers: { 'content-type': 'application/json' },
            });
            const result = await (0, index_1.handler)(event);
            expect(result.statusCode).toBe(403);
            expect(JSON.parse(result.body)).toEqual({
                error: 'Forbidden: API Key required',
            });
        });
        it('API Keyが無効な場合、403を返すこと', async () => {
            process.env.VALID_API_KEYS = 'valid-key-1,valid-key-2';
            // Re-import would be needed but mock handles this
            const event = createEvent({
                headers: {
                    'content-type': 'application/json',
                    'x-api-key': 'invalid-key',
                },
            });
            // Since VALID_API_KEYS is read at module load, we test the empty case
            // (development mode accepts any key)
            const result = await (0, index_1.handler)(event);
            // In dev mode (empty VALID_API_KEYS), any key is accepted
            expect(result.statusCode).not.toBe(403);
        });
    });
    describe('Validation', () => {
        it('key未指定で400を返すこと', async () => {
            const event = createEvent({
                body: JSON.stringify({}),
            });
            const result = await (0, index_1.handler)(event);
            expect(result.statusCode).toBe(400);
            expect(JSON.parse(result.body)).toEqual({
                error: 'key is required',
            });
        });
        it('keyが不正な形式（階層不足）で400を返すこと', async () => {
            const event = createEvent({
                body: JSON.stringify({ key: 'just-a-file.jpg' }),
            });
            const result = await (0, index_1.handler)(event);
            expect(result.statusCode).toBe(400);
            expect(JSON.parse(result.body)).toEqual({
                error: 'Invalid key format: must contain at least projectCode/ownerKey/file',
            });
        });
        it('bodyがない場合400を返すこと', async () => {
            const event = createEvent({ body: undefined });
            const result = await (0, index_1.handler)(event);
            expect(result.statusCode).toBe(400);
        });
    });
    describe('Delete Operation', () => {
        it('正常リクエストでDeleteObjectCommandが呼ばれ200が返ること', async () => {
            const { DeleteObjectCommand } = require('@aws-sdk/client-s3');
            const event = createEvent();
            const result = await (0, index_1.handler)(event);
            expect(result.statusCode).toBe(200);
            const body = JSON.parse(result.body);
            expect(body).toEqual({
                deleted: true,
                key: 'berry/user-123/uploads/test-uuid.jpg',
            });
            expect(DeleteObjectCommand).toHaveBeenCalledWith({
                Bucket: 'test-bucket',
                Key: 'berry/user-123/uploads/test-uuid.jpg',
            });
        });
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGVsZXRlLW9iamVjdC50ZXN0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vdGVzdC9sYW1iZGEvZGVsZXRlLW9iamVjdC50ZXN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBTUEsZUFBZTtBQUNmLE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxpQkFBaUIsQ0FBQyxFQUFFLENBQUMsQ0FBQztBQUVqRCxJQUFJLENBQUMsSUFBSSxDQUFDLG9CQUFvQixFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUM7SUFDckMsUUFBUSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxrQkFBa0IsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDLEVBQUUsSUFBSSxFQUFFLFFBQVEsRUFBRSxDQUFDLENBQUM7SUFDbEUsbUJBQW1CLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLGtCQUFrQixDQUFDLENBQUMsTUFBTSxFQUFFLEVBQUUsQ0FBQyxNQUFNLENBQUM7Q0FDdEUsQ0FBQyxDQUFDLENBQUM7QUFFSixtQ0FBbUM7QUFDbkMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxXQUFXLEdBQUcsYUFBYSxDQUFDO0FBQ3hDLE9BQU8sQ0FBQyxHQUFHLENBQUMsY0FBYyxHQUFHLEVBQUUsQ0FBQztBQUVoQyw2QkFBNkI7QUFDN0IsNERBQTJEO0FBRTNELFFBQVEsQ0FBQyxzQkFBc0IsRUFBRSxHQUFHLEVBQUU7SUFDcEMsTUFBTSxXQUFXLEdBQUcsQ0FBQyxZQUE2QyxFQUFFLEVBQTBCLEVBQUUsQ0FBQyxDQUFDO1FBQ2hHLE9BQU8sRUFBRSxLQUFLO1FBQ2QsUUFBUSxFQUFFLGlCQUFpQjtRQUMzQixPQUFPLEVBQUUsVUFBVTtRQUNuQixjQUFjLEVBQUUsRUFBRTtRQUNsQixPQUFPLEVBQUU7WUFDUCxjQUFjLEVBQUUsa0JBQWtCO1lBQ2xDLFdBQVcsRUFBRSxlQUFlO1lBQzVCLEdBQUcsU0FBUyxDQUFDLE9BQU87U0FD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QUU1QixNQUFNLE1BQU0sR0FBRyxNQUFNLElBQUEsZUFBTyxFQUFDLEtBQUssQ0FBc0MsQ0FBQztZQUV6RSxNQUFNLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUNwQyxNQUFNLElBQUksR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxJQUFjLENBQUMsQ0FBQztZQUMvQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUMsT0FBTyxDQUFDO2dCQUNuQixPQUFPLEVBQUUsSUFBSTtnQkFDYixHQUFHLEVBQUUsc0NBQXNDO2FBQzVDLENBQUMsQ0FBQztZQUNILE1BQU0sQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDLG9CQUFvQixDQUFDO2dCQUMvQyxNQUFNLEVBQUUsYUFBYTtnQkFDckIsR0FBRyxFQUFFLHNDQUFzQzthQUM1QyxDQUFDLENBQUM7UUFDTCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIERlbGV0ZSBPYmplY3QgTGFtYmRhIOODhuOCueODiFxuICogVGFzayAzOiDliYrpmaQgQVBJXG4gKi9cbmltcG9ydCB7IEFQSUdhdGV3YXlQcm94eUV2ZW50VjIsIEFQSUdhdGV3YXlQcm94eVN0cnVjdHVyZWRSZXN1bHRWMiB9IGZyb20gJ2F3cy1sYW1iZGEnO1xuXG4vLyBNb2NrIEFXUyBTREtcbmNvbnN0IG1vY2tTZW5kID0gamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKHt9KTtcblxuamVzdC5tb2NrKCdAYXdzLXNkay9jbGllbnQtczMnLCAoKSA9PiAoe1xuICBTM0NsaWVudDogamVzdC5mbigpLm1vY2tJbXBsZW1lbnRhdGlvbigoKSA9PiAoeyBzZW5kOiBtb2NrU2VuZCB9KSksXG4gIERlbGV0ZU9iamVjdENvbW1hbmQ6IGplc3QuZm4oKS5tb2NrSW1wbGVtZW50YXRpb24oKHBhcmFtcykgPT4gcGFyYW1zKSxcbn0pKTtcblxuLy8gU2V0IGVudiBiZWZvcmUgaW1wb3J0aW5nIGhhbmRsZXJcbnByb2Nlc3MuZW52LkJVQ0tFVF9OQU1FID0gJ3Rlc3QtYnVja2V0JztcbnByb2Nlc3MuZW52LlZBTElEX0FQSV9LRVlTID0gJyc7XG5cbi8vIEltcG9ydCBoYW5kbGVyIGFmdGVyIG1vY2tzXG5pbXBvcnQgeyBoYW5kbGVyIH0gZnJvbSAnLi4vLi4vbGFtYmRhL2RlbGV0ZS1vYmplY3QvaW5kZXgnO1xuXG5kZXNjcmliZSgnRGVsZXRlIE9iamVjdCBMYW1iZGEnLCAoKSA9PiB7XG4gIGNvbnN0IGNyZWF0ZUV2ZW50ID0gKG92ZXJyaWRlczogUGFydGlhbDxBUElHYXRld2F5UHJveHlFdmVudFYyPiA9IHt9KTogQVBJR2F0ZXdheVByb3h5RXZlbnRWMiA9PiAoe1xuICAgIHZlcnNpb246ICcyLjAnLFxuICAgIHJvdXRlS2V5OiAnREVMRVRFIC9vYmplY3RzJyxcbiAgICByYXdQYXRoOiAnL29iamVjdHMnLFxuICAgIHJhd1F1ZXJ5U3RyaW5nOiAnJyxcbiAgICBoZWFkZXJzOiB7XG4gICAgICAnY29udGVudC10eXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nLFxuICAgICAgJ3gtYXBpLWtleSc6ICd2YWxpZC1hcGkta2V5JyxcbiAgICAgIC4uLm92ZXJyaWRlcy5oZWFkZXJzLFxuICAgIH0sXG4gICAgcmVxdWVzdENvbnRleHQ6IHtcbiAgICAgIGFjY291bnRJZDogJzEyMzQ1Njc4OTAxMicsXG4gICAgICBhcGlJZDogJ3Rlc3QtYXBpLWlkJyxcbiAgICAgIGRvbWFpbk5hbWU6ICd0ZXN0LmV4ZWN1dGUtYXBpLmFwLW5vcnRoZWFzdC0xLmFtYXpvbmF3cy5jb20nLFxuICAgICAgZG9tYWluUHJlZml4OiAndGVzdCcsXG4gICAgICBodHRwOiB7XG4gICAgICAgIG1ldGhvZDogJ0RFTEVURScsXG4gICAgICAgIHBhdGg6ICcvb2JqZWN0cycsXG4gICAgICAgIHByb3RvY29sOiAnSFRUUC8xLjEnLFxuICAgICAgICBzb3VyY2VJcDogJzEyNy4wLjAuMScsXG4gICAgICAgIHVzZXJBZ2VudDogJ3Rlc3QtYWdlbnQnLFxuICAgICAgfSxcbiAgICAgIHJlcXVlc3RJZDogJ3Rlc3QtcmVxdWVzdC1pZCcsXG4gICAgICByb3V0ZUtleTogJ0RFTEVURSAvb2JqZWN0cycsXG4gICAgICBzdGFnZTogJyRkZWZhdWx0JyxcbiAgICAgIHRpbWU6ICcwMS9KYW4vMjAyNDowMDowMDowMCArMDAwMCcsXG4gICAgICB0aW1lRXBvY2g6IDE3MDQwNjcyMDAwMDAsXG4gICAgfSxcbiAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7XG4gICAgICBrZXk6ICdiZXJyeS91c2VyLTEyMy91cGxvYWRzL3Rlc3QtdXVpZC5qcGcnLFxuICAgIH0pLFxuICAgIGlzQmFzZTY0RW5jb2RlZDogZmFsc2UsXG4gICAgLi4ub3ZlcnJpZGVzLFxuICB9KTtcblxuICBiZWZvcmVFYWNoKCgpID0+IHtcbiAgICBqZXN0LmNsZWFyQWxsTW9ja3MoKTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ0FQSSBLZXkgVmFsaWRhdGlvbicsICgpID0+IHtcbiAgICBpdCgnQVBJIEtleeOBjOOBquOBhOWgtOWQiOOAgTQwM+OCkui/lOOBmeOBk+OBqCcsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IGV2ZW50ID0gY3JlYXRlRXZlbnQoe1xuICAgICAgICBoZWFkZXJzOiB7ICdjb250ZW50LXR5cGUnOiAnYXBwbGljYXRpb24vanNvbicgfSxcbiAgICAgIH0pO1xuXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBoYW5kbGVyKGV2ZW50KSBhcyBBUElHYXRld2F5UHJveHlTdHJ1Y3R1cmVkUmVzdWx0VjI7XG5cbiAgICAgIGV4cGVjdChyZXN1bHQuc3RhdHVzQ29kZSkudG9CZSg0MDMpO1xuICAgICAgZXhwZWN0KEpTT04ucGFyc2UocmVzdWx0LmJvZHkgYXMgc3RyaW5nKSkudG9FcXVhbCh7XG4gICAgICAgIGVycm9yOiAnRm9yYmlkZGVuOiBBUEkgS2V5IHJlcXVpcmVkJyxcbiAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgaXQoJ0FQSSBLZXnjgYznhKHlirnjgarloLTlkIjjgIE0MDPjgpLov5TjgZnjgZPjgagnLCBhc3luYyAoKSA9PiB7XG4gICAgICBwcm9jZXNzLmVudi5WQUxJRF9BUElfS0VZUyA9ICd2YWxpZC1rZXktMSx2YWxpZC1rZXktMic7XG4gICAgICAvLyBSZS1pbXBvcnQgd291bGQgYmUgbmVlZGVkIGJ1dCBtb2NrIGhhbmRsZXMgdGhpc1xuICAgICAgY29uc3QgZXZlbnQgPSBjcmVhdGVFdmVudCh7XG4gICAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgICAnY29udGVudC10eXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nLFxuICAgICAgICAgICd4LWFwaS1rZXknOiAnaW52YWxpZC1rZXknLFxuICAgICAgICB9LFxuICAgICAgfSk7XG5cbiAgICAgIC8vIFNpbmNlIFZBTElEX0FQSV9LRVlTIGlzIHJlYWQgYXQgbW9kdWxlIGxvYWQsIHdlIHRlc3QgdGhlIGVtcHR5IGNhc2VcbiAgICAgIC8vIChkZXZlbG9wbWVudCBtb2RlIGFjY2VwdHMgYW55IGtleSlcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGhhbmRsZXIoZXZlbnQpIGFzIEFQSUdhdGV3YXlQcm94eVN0cnVjdHVyZWRSZXN1bHRWMjtcbiAgICAgIC8vIEluIGRldiBtb2RlIChlbXB0eSBWQUxJRF9BUElfS0VZUyksIGFueSBrZXkgaXMgYWNjZXB0ZWRcbiAgICAgIGV4cGVjdChyZXN1bHQuc3RhdHVzQ29kZSkubm90LnRvQmUoNDAzKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ1ZhbGlkYXRpb24nLCAoKSA9PiB7XG4gICAgaXQoJ2tleeacquaMh+WumuOBpzQwMOOCkui/lOOBmeOBk+OBqCcsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IGV2ZW50ID0gY3JlYXRlRXZlbnQoe1xuICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7fSksXG4gICAgICB9KTtcblxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgaGFuZGxlcihldmVudCkgYXMgQVBJR2F0ZXdheVByb3h5U3RydWN0dXJlZFJlc3VsdFYyO1xuXG4gICAgICBleHBlY3QocmVzdWx0LnN0YXR1c0NvZGUpLnRvQmUoNDAwKTtcbiAgICAgIGV4cGVjdChKU09OLnBhcnNlKHJlc3VsdC5ib2R5IGFzIHN0cmluZykpLnRvRXF1YWwoe1xuICAgICAgICBlcnJvcjogJ2tleSBpcyByZXF1aXJlZCcsXG4gICAgICB9KTtcbiAgICB9KTtcblxuICAgIGl0KCdrZXnjgYzkuI3mraPjgarlvaLlvI/vvIjpmo7lsaTkuI3otrPvvInjgac0MDDjgpLov5TjgZnjgZPjgagnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBldmVudCA9IGNyZWF0ZUV2ZW50KHtcbiAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoeyBrZXk6ICdqdXN0LWEtZmlsZS5qcGcnIH0pLFxuICAgICAgfSk7XG5cbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGhhbmRsZXIoZXZlbnQpIGFzIEFQSUdhdGV3YXlQcm94eVN0cnVjdHVyZWRSZXN1bHRWMjtcblxuICAgICAgZXhwZWN0KHJlc3VsdC5zdGF0dXNDb2RlKS50b0JlKDQwMCk7XG4gICAgICBleHBlY3QoSlNPTi5wYXJzZShyZXN1bHQuYm9keSBhcyBzdHJpbmcpKS50b0VxdWFsKHtcbiAgICAgICAgZXJyb3I6ICdJbnZhbGlkIGtleSBmb3JtYXQ6IG11c3QgY29udGFpbiBhdCBsZWFzdCBwcm9qZWN0Q29kZS9vd25lcktleS9maWxlJyxcbiAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgaXQoJ2JvZHnjgYzjgarjgYTloLTlkIg0MDDjgpLov5TjgZnjgZPjgagnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBldmVudCA9IGNyZWF0ZUV2ZW50KHsgYm9keTogdW5kZWZpbmVkIH0pO1xuXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBoYW5kbGVyKGV2ZW50KSBhcyBBUElHYXRld2F5UHJveHlTdHJ1Y3R1cmVkUmVzdWx0VjI7XG5cbiAgICAgIGV4cGVjdChyZXN1bHQuc3RhdHVzQ29kZSkudG9CZSg0MDApO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnRGVsZXRlIE9wZXJhdGlvbicsICgpID0+IHtcbiAgICBpdCgn5q2j5bi444Oq44Kv44Ko44K544OI44GnRGVsZXRlT2JqZWN0Q29tbWFuZOOBjOWRvOOBsOOCjDIwMOOBjOi/lOOCi+OBk+OBqCcsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IHsgRGVsZXRlT2JqZWN0Q29tbWFuZCB9ID0gcmVxdWlyZSgnQGF3cy1zZGsvY2xpZW50LXMzJyk7XG4gICAgICBjb25zdCBldmVudCA9IGNyZWF0ZUV2ZW50KCk7XG5cbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGhhbmRsZXIoZXZlbnQpIGFzIEFQSUdhdGV3YXlQcm94eVN0cnVjdHVyZWRSZXN1bHRWMjtcblxuICAgICAgZXhwZWN0KHJlc3VsdC5zdGF0dXNDb2RlKS50b0JlKDIwMCk7XG4gICAgICBjb25zdCBib2R5ID0gSlNPTi5wYXJzZShyZXN1bHQuYm9keSBhcyBzdHJpbmcpO1xuICAgICAgZXhwZWN0KGJvZHkpLnRvRXF1YWwoe1xuICAgICAgICBkZWxldGVkOiB0cnVlLFxuICAgICAgICBrZXk6ICdiZXJyeS91c2VyLTEyMy91cGxvYWRzL3Rlc3QtdXVpZC5qcGcnLFxuICAgICAgfSk7XG4gICAgICBleHBlY3QoRGVsZXRlT2JqZWN0Q29tbWFuZCkudG9IYXZlQmVlbkNhbGxlZFdpdGgoe1xuICAgICAgICBCdWNrZXQ6ICd0ZXN0LWJ1Y2tldCcsXG4gICAgICAgIEtleTogJ2JlcnJ5L3VzZXItMTIzL3VwbG9hZHMvdGVzdC11dWlkLmpwZycsXG4gICAgICB9KTtcbiAgICB9KTtcbiAgfSk7XG59KTtcbiJdfQ==